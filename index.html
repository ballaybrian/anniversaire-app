<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>10 ans â€“ B & A</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F3EBDD;
      --card:rgba(255,255,255,.62);
      --border:#D9CDBA;
      --text:#5F7A68;
      --muted:rgba(95,122,104,.70);
      --btn:#8aa685;
      --btnText:#fff;
      --btnBorder:#6f8f6a;
      --success:#3F7C5A;
      --danger:#A34848;
      --radius:20px;
      --shadow:0 16px 40px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{max-width:780px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.45);font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--success);font-weight:900}
    .err{color:var(--danger);font-weight:900}

    header{display:grid;gap:10px;text-align:center;padding-bottom:8px}
    .brand{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px}
    h1{margin:0;font-family:"Playfair Display",serif;font-weight:700;font-size:clamp(32px,6vw,46px);line-height:1.05}
    .mono{font-family:"Playfair Display",serif;font-size:16px;letter-spacing:1px;opacity:.85;user-select:none}
    .subtitle{margin:0;font-size:14px;letter-spacing:1.1px;color:var(--muted)}
    .top-actions{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;align-items:center}

    button{width:100%;padding:14px;border-radius:16px;border:1px solid var(--btnBorder);background:var(--btn);color:var(--btnText);font-weight:900;letter-spacing:.2px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .smallbtn{width:auto;padding:10px 12px;border-radius:14px;font-size:13px}
    .btn-subtle{background:rgba(255,255,255,.55);border:1px solid var(--border);color:var(--text);font-weight:800}

    section[data-screen]{display:none}
    .fade-in{animation:fadeIn 220ms ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    #tableButtons{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;justify-items:center}
    #tableButtons button{max-width:170px;padding:16px 0;border-radius:18px}
    @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1.02)}}
    #tableButtons button.picked{animation:pop 220ms ease-out}

    .menuBlock{border:1px solid var(--border);border-radius:16px;padding:12px;background:rgba(255,255,255,.45);text-align:left}
    .menuTitle{font-weight:900;margin:0 0 8px}
    .menuText{border:1px dashed rgba(95,122,104,.35);border-radius:14px;padding:12px;background:rgba(255,255,255,.35);white-space:pre-wrap;min-height:54px}

    .progressWrap{border:1px solid var(--border);background:rgba(255,255,255,.45);border-radius:999px;padding:10px 10px 8px}
    .progressBar{height:12px;border-radius:999px;background:rgba(95,122,104,.20);overflow:hidden}
    .progressFill{height:100%;width:0%;border-radius:999px;background:var(--text);transition:width 260ms ease}
    .progressLabel{margin-top:8px;text-align:center;font-weight:900}
    .progressSub{margin-top:2px;text-align:center;font-size:12px;color:var(--muted);font-weight:800}

    .item{border:1px solid var(--border);border-radius:16px;padding:12px;background:rgba(255,255,255,.45);display:grid;gap:8px}
    .itemTitle{font-weight:900}
    .itemDesc{font-size:13px;color:var(--muted);line-height:1.35}
    .itemRow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .tiny{font-size:12px}

    input[type="text"],input[type="number"]{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.55);color:var(--text);font-size:16px;outline:none}

    /* Camera */
    .camBox{position:relative;border:1px solid var(--border);border-radius:18px;overflow:hidden;background:rgba(255,255,255,.35);box-shadow:0 12px 26px rgba(0,0,0,.08)}
    #camVideo,#camCanvas{width:100%;display:block;aspect-ratio:3/4;object-fit:cover;background:rgba(0,0,0,.04)}
    @media(min-width:520px){#camVideo,#camCanvas{aspect-ratio:16/9}}
    .flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity 120ms ease}
    .flash.on{opacity:.85}
    .flipIcon{display:inline-block;margin-right:8px;transition:transform 260ms ease;transform-origin:50% 50%}
    .flipIcon.spin{transform:rotate(180deg)}

    /* Album */
    .galleryGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(min-width:520px){.galleryGrid{grid-template-columns:repeat(4,1fr)}}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.35);cursor:pointer}
    .viewer{position:fixed;inset:0;background:rgba(0,0,0,.86);z-index:9999;display:none;padding:14px}
    .viewerTop{display:flex;justify-content:space-between;align-items:center;gap:10px;max-width:980px;margin:0 auto}
    .viewerImg{display:block;width:100%;height:calc(100% - 120px);max-width:980px;margin:12px auto 0;object-fit:contain;border-radius:14px;background:rgba(255,255,255,.06)}

    #bAdminReset{display:none}
    #bAdminReset.show{display:block}
  </style>
</head>
<body>
<div class="app"><div class="card">
  <header id="brandHold">
    <div class="brand">
      <div class="mono">B &amp; A</div>
      <h1>10 ans</h1>
      <div class="mono">B &amp; A</div>
    </div>
    <p class="subtitle">âœ¨ 2016 â€“ 2026 âœ¨</p>
    <div class="top-actions">
      <div id="tableBadge" class="pill" style="display:none;"></div>
      <button id="resetBtn" class="smallbtn" style="display:none;">Changer de table</button>
    </div>
  </header>

  <section id="screenHome" data-screen class="grid">
    <button id="homeTable">ğŸª‘ Table</button>
    <button id="homeMenu">ğŸ½ï¸ Menu</button>
    <button id="homeAlbum">ğŸ–¼ï¸ Album photo</button>
    <button id="homeGames">ğŸ‰ Jeux &amp; Photos</button>
    <div class="pill" id="countPill">ğŸ“· Photos envoyÃ©es : 0</div>
    <p class="muted" style="text-align:center;margin:0;">Envoi automatique sur Drive.</p>
  </section>

  <section id="screenTable" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">Choisis ta table</p>
    <div id="tableButtons"></div>
    <p class="muted" style="text-align:center;margin:0;">AprÃ¨s sÃ©lection, tu reviens Ã  lâ€™accueil.</p>
    <button id="backFromTable" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenMenu" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ½ï¸ Menu</p>
    <p class="muted" style="text-align:center;margin:0;">(Texte dÃ©fini dans le code â€” non modifiable)</p>
    <div class="menuBlock"><p class="menuTitle">EntrÃ©e</p><div id="menuEntree" class="menuText"></div></div>
    <div class="menuBlock"><p class="menuTitle">Plat</p><div id="menuPlat" class="menuText"></div></div>
    <div class="menuBlock"><p class="menuTitle">Fromage</p><div id="menuFromage" class="menuText"></div></div>
    <button id="backFromMenu" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenAlbum" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ–¼ï¸ Album photo</p>
    <p class="muted" style="text-align:center;margin:0;">Galerie interne (lecture seule).</p>
    <div class="grid grid2">
      <button id="refreshGallery" class="btn-subtle">ğŸ”„ Actualiser</button>
      <button id="openDriveAlbum" class="btn-subtle">ğŸ“‚ Ouvrir sur Drive</button>
    </div>
    <div id="galleryStatus" class="muted" style="text-align:center;"></div>
    <div id="gallery" class="galleryGrid"></div>
    <p class="muted" style="text-align:center;margin:0;">Si les images ne chargent pas : dossier Drive â†’ partage â€œToute personne avec le lien peut voirâ€.</p>
    <button id="backFromAlbum" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <div id="viewer" class="viewer">
    <div class="viewerTop">
      <button id="closeViewer" class="btn-subtle" style="max-width:160px;">âœ– Fermer</button>
      <div id="viewerName" class="pill" style="max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
    </div>
    <img id="viewerImg" class="viewerImg" alt="Photo">
    <div style="max-width:980px;margin:10px auto 0;display:flex;gap:10px;justify-content:space-between;">
      <button id="prevPhoto" class="btn-subtle" style="max-width:160px;">â—€</button>
      <button id="nextPhoto" class="btn-subtle" style="max-width:160px;">â–¶</button>
    </div>
  </div>

  <section id="screenGames" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ‰ Jeux &amp; Photos</p>
    <button id="goPhoto">ğŸ“¸ Prendre une photo</button>
    <button id="goDefis">ğŸ¯ DÃ©fis photos</button>
    <button id="goCodeGame">ğŸ” Code Game</button>
    <button id="goFableDept">ğŸ—ºï¸ Fable des dÃ©partements</button>
    <button id="goBouchons">ğŸ¾ Combien de bouchons ?</button>
    <button id="backFromGames" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenPhoto" data-screen class="grid">
    <p style="margin:0;text-align:center;font-weight:900;">Photobooth</p>
    <div class="muted" style="text-align:center;">
      Type : <span id="typeLabel" class="pill">libre</span>
      <span id="missionPill" class="pill" style="display:none;margin-left:6px;"></span>
    </div>
    <div class="grid grid2">
      <button class="typeBtn" data-type="libre">ğŸ“¸ Libre</button>
      <button class="typeBtn" data-type="defi">ğŸ¯ DÃ©fi</button>
    </div>
    <button class="typeBtn" data-type="codegame">ğŸ” Code Game</button>

    <div class="camBox">
      <video id="camVideo" playsinline autoplay muted></video>
      <canvas id="camCanvas" style="display:none;"></canvas>
      <div id="flash" class="flash"></div>
    </div>

    <div class="grid grid2">
      <button id="startCamBtn">ğŸ¥ Activer la camÃ©ra</button>
      <button id="switchCamBtn" class="btn-subtle">
        <span id="flipIcon" class="flipIcon">ğŸ”„</span><span id="switchCamText">Mode selfie</span>
      </button>
    </div>

    <div class="grid grid2">
      <button id="takePhotoBtn" disabled>ğŸ“¸ Prendre la photo</button>
      <button id="retakeBtn" style="display:none;" class="btn-subtle">ğŸ” Reprendre</button>
    </div>

    <div id="sendStatus" class="muted" style="text-align:center;"></div>
    <button id="backFromPhoto" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenDefis" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ¯ DÃ©fis photos</p>
    <p class="muted" style="text-align:center;margin:0;">Validez un dÃ©fi en prenant une photo.</p>
    <div class="progressWrap">
      <div class="progressBar"><div id="defisFill" class="progressFill"></div></div>
      <div id="defisPercent" class="progressLabel">0%</div>
      <div id="defisSub" class="progressSub">0 / 0 dÃ©fis</div>
    </div>
    <div id="defisList" class="grid"></div>
    <button id="resetDefisBtn" class="btn-subtle">RÃ©initialiser les dÃ©fis</button>
    <button id="backFromDefis" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenCodeGame" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ” Code Game</p>
    <div class="menuBlock"><p class="menuTitle">RÃ¨gles &amp; rÃ©compense</p><div id="codeRules" class="menuText"></div></div>
    <div class="progressWrap">
      <div class="progressBar"><div id="codeFill" class="progressFill"></div></div>
      <div id="codePercent" class="progressLabel">0%</div>
      <div id="codeSub" class="progressSub">0 / 0 Ã©nigmes</div>
    </div>
    <div id="enigmesList" class="grid"></div>
    <button id="resetCodeBtn" class="btn-subtle">RÃ©initialiser le Code Game</button>
    <button id="backFromCode" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenFableDept" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ—ºï¸ La fable des dÃ©partements</p>
    <div class="menuBlock"><p class="menuTitle">RÃ¨gles &amp; rÃ©compense</p><div id="fableRules" class="menuText"></div></div>
    <div class="progressWrap">
      <div class="progressBar"><div id="fableFill" class="progressFill"></div></div>
      <div id="fablePercent" class="progressLabel">0%</div>
      <div id="fableSub" class="progressSub">0 / 0 mots</div>
    </div>
    <div class="menuBlock"><p class="menuTitle">Histoire</p><div id="fableText" class="menuText"></div></div>
    <div class="item">
      <div class="itemTitle">Trou actuel</div>
      <div id="fablePrompt" class="muted">â€”</div>
      <div class="grid grid2" style="margin-top:10px;">
        <input id="fableInput" type="text" placeholder="Ta rÃ©ponseâ€¦">
        <button id="fableValidate">Valider</button>
      </div>
      <div id="fableStatus" class="muted tiny" style="margin-top:8px;"></div>
      <button id="fableNext" class="btn-subtle" style="margin-top:10px;">Passer au trou suivant</button>
    </div>
    <button id="resetFableBtn" class="btn-subtle">RÃ©initialiser la fable</button>
    <button id="backFromFableDept" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

  <section id="screenBouchons" data-screen class="grid">
    <p style="text-align:center;margin:0;font-weight:900;">ğŸ¾ Combien de bouchons ?</p>
    <p class="muted" style="text-align:center;margin:0;">Trouve le bon nombre. Le jeu se bloque dÃ¨s quâ€™un gagnant trouve.</p>

    <div class="item">
      <div class="itemTitle">Ta proposition</div>
      <div class="grid grid2">
        <input id="bGuess" type="number" min="0" step="1">
        <button id="bSubmit">Valider</button>
      </div>

      <div id="bHint" class="pill" style="text-align:center;display:none;"></div>

      <div style="margin-top:10px;">
        <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:900;color:rgba(95,122,104,.75);">
          <span>ğŸ§Š Loin</span><span>ğŸ”¥ Proche</span>
        </div>
        <div style="margin-top:6px;height:14px;border-radius:999px;overflow:hidden;border:1px solid var(--border);background:rgba(255,255,255,.45);">
          <div id="bThermoFill" style="height:100%;width:0%;border-radius:999px;transition:width 260ms ease, background-color 260ms ease;"></div>
        </div>
        <div id="bThermoText" class="muted tiny" style="text-align:center;margin-top:6px;"></div>
      </div>

      <div id="bStatus" class="muted tiny" style="margin-top:8px;"></div>
      <button id="bAdminReset" class="btn-subtle">ğŸ” RÃ©initialiser le jeu (ADMIN)</button>
    </div>

    <div class="item">
      <div class="itemTitle">Ã‰tat du jeu</div>
      <div id="bLockInfo" class="muted">Chargementâ€¦</div>
    </div>

    <button id="backFromBouchons" class="btn-subtle">â¬…ï¸ Retour</button>
  </section>

</div></div>

<script>
/* ================= CONFIG ================= */
const APPS_SCRIPT_URL = "PASTE_YOUR_SCRIPT_URL_HERE";
const DRIVE_ALBUM_FOLDER_ID = "PASTE_YOUR_FOLDER_ID_HERE";

/* Menu (modifie ici) */
const MENU_ENTREE  = `Ã€ complÃ©terâ€¦`;
const MENU_PLAT    = `Ã€ complÃ©terâ€¦`;
const MENU_FROMAGE = `Ã€ complÃ©terâ€¦`;

/* RÃ¨gles (modifie ici) */
const CODEGAME_RULES = `RÃˆGLES :
- RÃ©sous les Ã©nigmes pour rÃ©vÃ©ler un chiffre.
- Ã€ la fin, assemble les chiffres pour ouvrir le cadenas.

RÃ‰COMPENSE :
ğŸ Ã€ complÃ©terâ€¦`;

const FABLE_RULES = `RÃˆGLES :
- ComplÃ¨te les trous de lâ€™histoire avec le bon dÃ©partement.
- Accents non obligatoires.
- Tirets/espaces acceptÃ©s.

RÃ‰COMPENSE :
ğŸ Ã€ complÃ©terâ€¦`;

/* Tables */
const TABLES = Array.from({length:9}, (_,i)=>({id:i+1, name:`Table ${i+1}`}));

/* DÃ©fis */
const DEFIS = [
  { id:"d1", title:"Tout le monde saute", desc:"Photo oÃ¹ tout le monde saute en mÃªme temps." },
  { id:"d2", title:"La plus drÃ´le", desc:"Faites la photo la plus drÃ´le possible." },
  { id:"d3", title:"Couple (ou duo)", desc:"Photo en duo, pose stylÃ©e." },
  { id:"d4", title:"Objet rouge", desc:"Un objet rouge bien visible dans lâ€™image." },
  { id:"d5", title:"Sans sourire", desc:"Tout le monde sÃ©rieux ğŸ˜" },
];

/* Code Game */
const ENIGMES = [
  { id:"e1", q:"Je suis plein de trous mais je retiens lâ€™eau. Qui suis-je ?", a:"eponge", digit:"3" },
  { id:"e2", q:"Plus jâ€™ai de gardiens, moins je suis en sÃ©curitÃ©. Qui suis-je ?", a:"secret", digit:"2" },
  { id:"e3", q:"Je monte et je descends sans bouger. Qui suis-je ?", a:"escalier", digit:"6" },
  { id:"e4", q:"j'ai eu que 5 de moyen en FranÃ§ais. Qui suis-je ?", a:"nolan", digit:"9" },
];

/* Fable des dÃ©partements */
const FABLE_WORDS = ["CALVADOS","MANCHE","LOIRE","LOIR-ET-CHER","SAVOIE","DOUBS","VIENNE","GARD","NORD","AVEYRON","GIRONDE","AUBE","PAS-DE-CALAIS","ARDENNES","CANTAL","HERAULT","CORSE","EURE","SOMME","CHER","SEINE","AISNE","ALLIER","BAS-RHIN","JURA"];
const FABLE_TEXT_TEMPLATE =
`J'Ã©tais assis au bar en train de boire un {0} tandis que je regardais un
clochard faire la {1}.
Une dame vint s'asseoir Ã  cÃ´tÃ© de moi ; elle portait un manteau de {2} et j'en
fus impressionnÃ© car je sais que le {3}.
Nous engageÃ¢mes la conversation, et ce qui me charma chez elle furent {4}
et ses yeux {5}.
Au bout de quelques minutes, elle me proposa de monter chez elle. Il fallait donc
que je {6} et j'acceptai sans crier {7}.
Elle ne perdit pas le {8}. Nous entrÃ¢mes dans sa chambre, et Ã  peine arrivÃ©s,
elle se dÃ©shabilla ; ses seins Ã©taient magnifiques, elle les {9} !!!
En fait cette fille Ã©tait vraiment {10} et l'on s'amusa jusqu'Ã  l'{11}. 
LÃ , il ne s'agit {12} !
L'exercice Ã§a CREUSE, aussi, au petit matin, je lui proposai du jambon des
{13}, du saucisson et du {14}.
Elle fut si contente de ce petit dÃ©jeuner, qu'elle m'appela son {15}.
OÃ¹ l'histoire se {16}, c'est que lorsqu'on eut fini, un peu fatiguÃ©s, elle
regarda l'{17} et me demanda une {18} que je refusai de payer, trouvant
que c'Ã©tait trop {19}.
Elle me fit alors une terrible {20} et je vis dans ses yeux beaucoup de
{21}.
A cet instant, j'aurais bien eu besoin d'un {22} car elle me lanÃ§a son sac au
visage et me donna un coup de pied dans le {23}.
Tout finit par s'arranger, mais avec des histoires pareilles, elle {24} qu'on ne
l'y prendrait plus.`;

/* LocalStorage */
const LS={tableId:"bday_tableId",photoType:"bday_photoType",uploading:"bday_uploading",count:"bday_photo_count",camMode:"bday_cam_mode",mission:"bday_mission",defisDone:"bday_defis_done",codeOk:"bday_code_ok",fableOk:"bday_fable_dept_ok"};
const $=id=>document.getElementById(id);
const screens=()=>Array.from(document.querySelectorAll("[data-screen]"));

function setScreen(id){
  for(const el of screens()) el.style.display="none";
  const t=$(id); if(!t) return;
  t.style.display="grid"; t.classList.add("fade-in");
  setTimeout(()=>t.classList.remove("fade-in"),260);
}

const getTableId=()=>Number(localStorage.getItem(LS.tableId)||0);
const setTableId=v=>localStorage.setItem(LS.tableId,String(v));
const getCount=()=>Number(localStorage.getItem(LS.count)||0);
const incCount=()=>{localStorage.setItem(LS.count,String(getCount()+1)); updateCountUI();};
const updateCountUI=()=>{$("countPill").textContent=`ğŸ“· Photos envoyÃ©es : ${getCount()}`;};

function updateBadge(){
  const id=getTableId();
  const badge=$("tableBadge"), reset=$("resetBtn");
  if(!id){badge.style.display="none";reset.style.display="none";return;}
  badge.textContent=`ğŸª‘ Table ${id}`; badge.style.display="inline-block"; reset.style.display="inline-block";
}

function renderMenu(){
  $("menuEntree").textContent=MENU_ENTREE;
  $("menuPlat").textContent=MENU_PLAT;
  $("menuFromage").textContent=MENU_FROMAGE;
}

function renderTables(){
  const wrap=$("tableButtons"); wrap.innerHTML="";
  TABLES.forEach(t=>{
    const b=document.createElement("button");
    b.textContent=t.name;
    b.onclick=()=>{b.classList.add("picked"); setTableId(t.id); updateBadge(); setTimeout(()=>setScreen("screenHome"),220);};
    wrap.appendChild(b);
  });
}

function setProgress(fillEl, percentEl, subEl, done, total, label){
  const pct=total?Math.round(done/total*100):0;
  fillEl.style.width=pct+"%";
  percentEl.textContent=pct+"%";
  subEl.textContent=`${done} / ${total} ${label}`;
}
function normalize(s){return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");}

function getDefisDone(){try{return JSON.parse(localStorage.getItem(LS.defisDone)||"{}");}catch{return {};}}
function setDefisDone(o){localStorage.setItem(LS.defisDone,JSON.stringify(o));}
function markDefiDone(id){const d=getDefisDone(); d[id]=true; setDefisDone(d);}
function resetDefis(){localStorage.removeItem(LS.defisDone);}

function setMission(o){localStorage.setItem(LS.mission,JSON.stringify(o||null)); updateMissionPill();}
function getMission(){try{return JSON.parse(localStorage.getItem(LS.mission)||"null");}catch{return null;}}
function clearMission(){localStorage.removeItem(LS.mission); updateMissionPill();}
function updateMissionPill(){
  const m=getMission(), pill=$("missionPill");
  if(m&&m.title){pill.style.display="inline-block"; pill.textContent=`ğŸ¯ ${m.title}`;}
  else{pill.style.display="none"; pill.textContent="";}
}
function setPhotoType(v){localStorage.setItem(LS.photoType,v);}
function getPhotoType(){return localStorage.getItem(LS.photoType)||"libre";}
function setTypeUI(t){setPhotoType(t); $("typeLabel").textContent=(t==="codegame")?"code game":t;}

function renderDefis(){
  const done=getDefisDone(); const wrap=$("defisList"); wrap.innerHTML="";
  const nbDone=DEFIS.filter(d=>done[d.id]).length;
  setProgress($("defisFill"),$("defisPercent"),$("defisSub"),nbDone,DEFIS.length,"dÃ©fis");
  DEFIS.forEach(d=>{
    const isDone=!!done[d.id];
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`
      <div class="itemRow">
        <div>
          <div class="itemTitle">${isDone?"âœ…":"â³"} ${d.title}</div>
          <div class="itemDesc">${d.desc}</div>
        </div>
        <div style="min-width:160px;">
          <button class="${isDone?"btn-subtle":""}">${isDone?"Reprendre":"ğŸ“¸ Faire ce dÃ©fi"}</button>
        </div>
      </div>
      <div class="muted tiny">${isDone?"DÃ©fi validÃ©":"Appuie pour ouvrir lâ€™appareil photo"}</div>`;
    div.querySelector("button").onclick=()=>{
      setTypeUI("defi");
      setMission({kind:"defi", id:d.id, title:d.title});
      setScreen("screenPhoto");
    };
    wrap.appendChild(div);
  });
}

function getCodeOk(){try{return JSON.parse(localStorage.getItem(LS.codeOk)||"{}");}catch{return {};}}
function setCodeOk(o){localStorage.setItem(LS.codeOk,JSON.stringify(o));}
function resetCodeGame(){localStorage.removeItem(LS.codeOk);}

function renderCodeGame(){
  $("codeRules").textContent=CODEGAME_RULES;
  const ok=getCodeOk(); const wrap=$("enigmesList"); wrap.innerHTML="";
  const nbOk=ENIGMES.filter(e=>ok[e.id]).length;
  setProgress($("codeFill"),$("codePercent"),$("codeSub"),nbOk,ENIGMES.length,"Ã©nigmes");
  ENIGMES.forEach(e=>{
    const isOk=!!ok[e.id];
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`
      <div class="itemTitle">${isOk?"âœ…":"ğŸ”"} Ã‰nigme</div>
      <div class="itemDesc">${e.q}</div>
      <div class="grid grid2">
        <input type="text" id="ans_${e.id}" placeholder="Ta rÃ©ponseâ€¦" ${isOk?"disabled":""}>
        <button id="btn_${e.id}" class="${isOk?"btn-subtle":""}" ${isOk?"disabled":""}>Valider</button>
      </div>
      <div class="muted tiny" id="st_${e.id}">${isOk?`ğŸ‰ Chiffre rÃ©vÃ©lÃ© : <span class="ok">${e.digit}</span>`:""}</div>`;
    wrap.appendChild(div);
    if(!isOk){
      div.querySelector(`#btn_${e.id}`).onclick=()=>{
        const v=div.querySelector(`#ans_${e.id}`).value;
        const st=div.querySelector(`#st_${e.id}`);
        if(normalize(v)===normalize(e.a)){
          const next=getCodeOk(); next[e.id]=true; setCodeOk(next);
          st.innerHTML=`ğŸ‰ Chiffre rÃ©vÃ©lÃ© : <span class="ok">${e.digit}</span>`;
          renderCodeGame();
        }else st.innerHTML=`<span class="err">âŒ Mauvaise rÃ©ponse</span>`;
      };
    }
  });
}

/* Camera */
let camStream=null, capturedDataUrl=null;
let cameraMode=localStorage.getItem(LS.camMode)||"environment";
function updateSwitchCamUI(){ $("switchCamText").textContent=(cameraMode==="user")?"CamÃ©ra arriÃ¨re":"Mode selfie"; }
function spinFlipIcon(){ $("flipIcon").classList.toggle("spin"); setTimeout(()=>$("flipIcon").classList.toggle("spin"),280); }
function flash(){ $("flash").classList.add("on"); setTimeout(()=>$("flash").classList.remove("on"),140); }

async function startCamera(){
  try{
    $("sendStatus").textContent="ğŸ¥ Activation camÃ©raâ€¦";
    if(camStream) camStream.getTracks().forEach(t=>t.stop());
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:cameraMode,width:{ideal:1280},height:{ideal:720}},audio:false});
    $("camVideo").srcObject=camStream;
    $("takePhotoBtn").disabled=false;
    $("sendStatus").textContent="";
  }catch(e){
    $("sendStatus").innerHTML=`<span class="err">âŒ CamÃ©ra refusÃ©e. Autorise-la via le cadenas ğŸ”’.</span>`;
  }
}
function stopCamera(){ if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;} $("camVideo").srcObject=null; $("takePhotoBtn").disabled=true; }
function takePhoto(){
  const v=$("camVideo"), c=$("camCanvas");
  const w=v.videoWidth||1280, h=v.videoHeight||720;
  c.width=w; c.height=h; c.getContext("2d").drawImage(v,0,0,w,h);
  capturedDataUrl=c.toDataURL("image/jpeg",.8);
  flash(); $("sendStatus").innerHTML=`<span class="muted">ğŸ“¤ Envoi automatiqueâ€¦</span>`;
  $("retakeBtn").style.display="block";
  setTimeout(sendPhotoAuto,200);
}
async function sendPhotoAuto(){
  const tableId=getTableId();
  if(!tableId){ $("sendStatus").innerHTML=`<span class="err">Choisis dâ€™abord une table.</span>`; setScreen("screenTable"); return; }
  if(!capturedDataUrl) return;
  if(localStorage.getItem(LS.uploading)==="1") return;
  localStorage.setItem(LS.uploading,"1");
  const mission=getMission();
  try{
    await fetch(APPS_SCRIPT_URL,{
      method:"POST",mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify({tableId,type:getPhotoType(),filename:`table${tableId}_${getPhotoType()}_${Date.now()}.jpg`,dataUrl:capturedDataUrl,mission:mission||null})
    });
    incCount();
    if(mission&&mission.kind==="defi"&&mission.id) markDefiDone(mission.id);
    $("sendStatus").innerHTML=`<span class="ok">âœ… Photo envoyÃ©e ğŸ‰</span>`;
    capturedDataUrl=null; $("retakeBtn").style.display="none"; clearMission();
    setTimeout(()=>setScreen("screenGames"),900);
  }catch(e){
    $("sendStatus").innerHTML=`<span class="err">âŒ Erreur rÃ©seau.</span>`;
  }finally{
    setTimeout(()=>localStorage.removeItem(LS.uploading),800);
  }
}

/* Album */
let albumItems=[], viewerIndex=-1;
async function loadGallery(){
  $("galleryStatus").textContent="Chargement des photosâ€¦";
  $("gallery").innerHTML=""; albumItems=[];
  try{
    const url=`${APPS_SCRIPT_URL}?action=album_list&folderId=${encodeURIComponent(DRIVE_ALBUM_FOLDER_ID)}&t=${Date.now()}`;
    const res=await fetch(url,{method:"GET",cache:"no-store"});
    const data=await res.json();
    if(!data.ok){ $("galleryStatus").innerHTML=`<span class="err">${data.message||"Erreur galerie"}</span>`; return; }
    albumItems=Array.isArray(data.items)?data.items:[];
    if(albumItems.length===0){ $("galleryStatus").textContent="Aucune photo pour le moment."; return; }
    $("galleryStatus").textContent=`${albumItems.length} photo(s)`;
    albumItems.forEach(it=>{
      const img=document.createElement("img");
      img.className="thumb"; img.loading="lazy"; img.src=it.thumbUrl||it.imgUrl; img.alt=it.name||"photo";
      img.onclick=()=>openViewer(it);
      $("gallery").appendChild(img);
    });
  }catch(e){
    $("galleryStatus").innerHTML=`<span class="err">Erreur de chargement (droits Drive ?)</span>`;
  }
}
function openViewer(it){
  viewerIndex=albumItems.findIndex(x=>x.id===it.id); if(viewerIndex<0) viewerIndex=0;
  renderViewer(); $("viewer").style.display="block";
}
function renderViewer(){
  const it=albumItems[viewerIndex]; if(!it) return;
  $("viewerImg").src=it.fullUrl||it.imgUrl||it.thumbUrl;
  $("viewerName").textContent=it.name||"";
  $("prevPhoto").disabled=(viewerIndex<=0);
  $("nextPhoto").disabled=(viewerIndex>=albumItems.length-1);
  $("viewerImg").onerror=()=>{ if(it.viewUrl) window.open(it.viewUrl,"_blank","noopener"); closeViewer(); };
}
function closeViewer(){ $("viewer").style.display="none"; $("viewerImg").src=""; $("viewerName").textContent=""; viewerIndex=-1; }
function prevViewer(){ if(viewerIndex>0){viewerIndex--; renderViewer();} }
function nextViewer(){ if(viewerIndex<albumItems.length-1){viewerIndex++; renderViewer();} }

/* Fable */
function normalizeDept(s){
  return (s||"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/['â€™]/g,"'")
    .replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");
}
function getFableOk(){try{return JSON.parse(localStorage.getItem(LS.fableOk)||"{}");}catch{return {};}}
function setFableOk(o){localStorage.setItem(LS.fableOk,JSON.stringify(o));}
function resetFable(){localStorage.removeItem(LS.fableOk); fableIndex=0;}
let fableIndex=0;

function renderFable(){
  $("fableRules").textContent=FABLE_RULES;
  const ok=getFableOk(), total=FABLE_WORDS.length, done=Object.keys(ok).length;
  setProgress($("fableFill"),$("fablePercent"),$("fableSub"),done,total,"mots");

  let txt=FABLE_TEXT_TEMPLATE;
  for(let i=0;i<total;i++){
    txt=txt.replace(`{${i}}`, ok[String(i)]?`âœ… ${FABLE_WORDS[i]}`:"____");
  }
  $("fableText").textContent=txt;

  let next=-1; for(let i=0;i<total;i++){ if(!ok[String(i)]){next=i;break;} }
  if(next===-1){
    $("fablePrompt").innerHTML=`<span class="ok">Bravo ! Tout est complÃ©tÃ© ğŸ‰</span>`;
    $("fableInput").disabled=true; $("fableValidate").disabled=true; $("fableNext").disabled=true; $("fableStatus").textContent="";
    return;
  }
  fableIndex=next;
  $("fablePrompt").innerHTML=`Trou <b>${next+1}</b> / ${total}`;
  $("fableInput").disabled=false; $("fableValidate").disabled=false; $("fableNext").disabled=false;
  $("fableInput").value=""; $("fableStatus").textContent="";
}
function validateFable(){
  const expected=FABLE_WORDS[fableIndex], user=$("fableInput").value;
  if(normalizeDept(user)===normalizeDept(expected)){
    const ok=getFableOk(); ok[String(fableIndex)]=true; setFableOk(ok);
    $("fableStatus").innerHTML=`<span class="ok">âœ… Correct : ${expected}</span>`;
    setTimeout(renderFable,250);
  }else $("fableStatus").innerHTML=`<span class="err">âŒ Mauvais mot</span>`;
}
function nextFableHole(){
  const ok=getFableOk();
  for(let i=fableIndex+1;i<FABLE_WORDS.length;i++){ if(!ok[String(i)]){fableIndex=i;break;} }
  $("fableInput").value=""; $("fableStatus").textContent="";
  $("fablePrompt").innerHTML=`Trou <b>${fableIndex+1}</b> / ${FABLE_WORDS.length}`;
}

/* Bouchons */
async function bouchonsState(){ const r=await fetch(`${APPS_SCRIPT_URL}?action=bouchons_state&t=${Date.now()}`,{cache:"no-store"}); return await r.json(); }
async function bouchonsGuess(guess){
  const r=await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"bouchons_guess",guess})});
  return await r.json();
}
async function bouchonsReset(code){
  const r=await fetch(`${APPS_SCRIPT_URL}?action=bouchons_reset&code=${encodeURIComponent(code)}&t=${Date.now()}`,{cache:"no-store"});
  return await r.json();
}
const BOUCHONS_MAX_DIFF=250;
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
function updateBouchonsGauge(diff){
  const d=clamp(Number(diff),0,BOUCHONS_MAX_DIFF);
  const pct=Math.round((1-(d/BOUCHONS_MAX_DIFF))*100);
  const hue=Math.round(210*(1-pct/100));
  $("bThermoFill").style.width=pct+"%";
  $("bThermoFill").style.backgroundColor=`hsl(${hue} 85% 55%)`;
  let label="ğŸ¥¶ TrÃ¨s loin";
  if(pct>=20) label="ğŸ§Š Loin";
  if(pct>=40) label="ğŸ™‚ TiÃ¨de";
  if(pct>=60) label="ğŸŒ¡ï¸ Chaud";
  if(pct>=80) label="ğŸ”¥ TrÃ¨s chaud";
  if(pct>=95) label="ğŸš¨ BrÃ»lant";
  $("bThermoText").textContent=`${label} â€” ${pct}%`;
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  screens().forEach(el=>el.style.display="none");
  renderTables(); renderMenu(); updateBadge(); updateCountUI(); setTypeUI(getPhotoType()); updateSwitchCamUI(); updateMissionPill();
  setScreen("screenHome");

  $("homeTable").onclick=()=>setScreen("screenTable");
  $("homeMenu").onclick=()=>setScreen("screenMenu");
  $("homeAlbum").onclick=async()=>{setScreen("screenAlbum"); await loadGallery();};
  $("homeGames").onclick=()=>setScreen("screenGames");

  $("backFromTable").onclick=()=>setScreen("screenHome");
  $("backFromMenu").onclick=()=>setScreen("screenHome");
  $("backFromAlbum").onclick=()=>setScreen("screenHome");
  $("backFromGames").onclick=()=>setScreen("screenHome");

  $("refreshGallery").onclick=loadGallery;
  $("openDriveAlbum").onclick=()=>window.open(`https://drive.google.com/drive/folders/${encodeURIComponent(DRIVE_ALBUM_FOLDER_ID)}`,"_blank","noopener");
  $("closeViewer").onclick=closeViewer;
  $("prevPhoto").onclick=prevViewer;
  $("nextPhoto").onclick=nextViewer;
  $("viewer").addEventListener("click",e=>{if(e.target.id==="viewer") closeViewer();});

  // Reset table
  $("resetBtn").onclick=()=>{setTableId(0); updateBadge(); setScreen("screenTable");};

  // Games
  $("goPhoto").onclick=()=>{clearMission(); $("sendStatus").textContent=""; $("retakeBtn").style.display="none"; setTypeUI("libre"); setScreen("screenPhoto");};
  $("goDefis").onclick=()=>{renderDefis(); setScreen("screenDefis");};
  $("goCodeGame").onclick=()=>{renderCodeGame(); setScreen("screenCodeGame");};
  $("goFableDept").onclick=()=>{renderFable(); setScreen("screenFableDept");};
  $("goBouchons").onclick=async()=>{
    setScreen("screenBouchons");
    $("bGuess").value=""; $("bHint").style.display="none"; $("bThermoFill").style.width="0%"; $("bThermoText").textContent=""; $("bStatus").textContent="";
    const st=await bouchonsState();
    if(st.locked){
      $("bLockInfo").innerHTML=`<span class="ok">âœ… Jeu terminÃ© : un gagnant a trouvÃ© le bon nombre.</span>`;
      $("bSubmit").disabled=true; $("bGuess").disabled=true;
      updateBouchonsGauge(0);
      $("bHint").style.display="block"; $("bHint").textContent="âœ… TrouvÃ© !";
    }else{
      $("bLockInfo").innerHTML=`<span class="muted">Jeu ouvert : Ã  vous de jouer !</span>`;
      $("bSubmit").disabled=false; $("bGuess").disabled=false;
    }
  };

  $("backFromDefis").onclick=()=>setScreen("screenGames");
  $("backFromCode").onclick=()=>setScreen("screenGames");
  $("backFromFableDept").onclick=()=>setScreen("screenGames");
  $("backFromBouchons").onclick=()=>setScreen("screenGames");

  document.querySelectorAll(".typeBtn").forEach(btn=>{
    btn.onclick=()=>{clearMission(); setTypeUI(btn.dataset.type); updateMissionPill();};
  });

  $("startCamBtn").onclick=startCamera;
  $("takePhotoBtn").onclick=takePhoto;
  $("switchCamBtn").onclick=()=>{
    cameraMode=(cameraMode==="environment")?"user":"environment";
    localStorage.setItem(LS.camMode,cameraMode);
    spinFlipIcon(); updateSwitchCamUI();
    if(camStream) startCamera();
  };
  $("retakeBtn").onclick=()=>{capturedDataUrl=null; $("sendStatus").innerHTML=`<span class="muted">ğŸ“¸ Reprends la photo</span>`;};
  $("backFromPhoto").onclick=()=>{stopCamera(); setScreen("screenGames");};

  $("resetDefisBtn").onclick=()=>{resetDefis(); renderDefis();};
  $("resetCodeBtn").onclick=()=>{resetCodeGame(); renderCodeGame();};

  $("resetFableBtn").onclick=()=>{resetFable(); renderFable();};
  $("fableValidate").onclick=validateFable;
  $("fableNext").onclick=nextFableHole;
  $("fableInput").addEventListener("keydown",e=>{if(e.key==="Enter") validateFable();});

  $("bSubmit").onclick=async()=>{
    const guess=Number($("bGuess").value);
    if(!Number.isFinite(guess)||guess<0){$("bStatus").innerHTML=`<span class="err">Entre un nombre valide.</span>`;return;}
    $("bStatus").textContent="Analyseâ€¦";
    const st=await bouchonsGuess(guess);
    $("bHint").style.display="block";
    if(st.tooLow) $("bHint").textContent="ğŸ“ˆ Trop bas";
    else if(st.tooHigh) $("bHint").textContent="ğŸ“‰ Trop haut";
    if(typeof st.diff==="number") updateBouchonsGauge(st.diff);

    if(st.locked){
      $("bLockInfo").innerHTML=`<span class="ok">âœ… Jeu terminÃ© : un gagnant a trouvÃ© le bon nombre.</span>`;
      $("bSubmit").disabled=true; $("bGuess").disabled=true;
      $("bStatus").innerHTML=`<span class="ok">âœ… TrouvÃ© ! Jeu bloquÃ©.</span>`;
      $("bHint").textContent="âœ… TrouvÃ© !";
    }else{
      $("bLockInfo").innerHTML=`<span class="muted">Jeu ouvert : Ã  vous de jouer !</span>`;
      $("bStatus").textContent=st.message||"EnregistrÃ©.";
    }
  };

  // admin reset: appui long sur le header
  let holdTimer=null;
  $("brandHold").addEventListener("pointerdown",()=>{holdTimer=setTimeout(()=>{$("bAdminReset").classList.toggle("show");},1200);});
  ["pointerup","pointercancel","pointerleave"].forEach(evt=>$("brandHold").addEventListener(evt,()=>{if(holdTimer) clearTimeout(holdTimer); holdTimer=null;}));

  $("bAdminReset").onclick=async()=>{
    const code=prompt("Code ADMIN pour rÃ©initialiser le jeu :");
    if(!code) return;
    $("bStatus").textContent="â³ RÃ©initialisationâ€¦";
    $("bAdminReset").disabled=true;
    try{
      const r=await bouchonsReset(code);
      if(!r.ok){$("bStatus").innerHTML=`<span class="err">${r.message||"Erreur reset"}</span>`;return;}
      const st=await bouchonsState();
      if(st.locked) $("bStatus").innerHTML=`<span class="err">Reset reÃ§u mais le jeu est encore verrouillÃ© (dÃ©ploiement pas Ã  jour).</span>`;
      else{
        $("bStatus").innerHTML=`<span class="ok">âœ… Jeu rÃ©initialisÃ©</span>`;
        $("bGuess").value=""; $("bHint").style.display="none"; $("bThermoText").textContent=""; $("bThermoFill").style.width="0%";
        $("bSubmit").disabled=false; $("bGuess").disabled=false;
        $("bLockInfo").innerHTML=`<span class="muted">Jeu ouvert : Ã  vous de jouer !</span>`;
      }
    }catch(e){
      $("bStatus").innerHTML=`<span class="err">âŒ Reset bloquÃ© (rÃ©seau/autorisation).</span>`;
    }finally{
      $("bAdminReset").disabled=false;
    }
  };
});
</script>
</body>
</html>
