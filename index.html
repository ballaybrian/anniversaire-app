<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>10 ans</title>

  <!-- Typographies √©l√©gantes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #F3EBDD;
      --card: rgba(255,255,255,0.62);
      --border: #D9CDBA;

      --text: #5F7A68;
      --muted: rgba(95,122,104,0.70);

      --btn: #CBB79A;
      --btnText: #2F2A22;
      --btnBorder: #B39E7E;

      --success: #3F7C5A;
      --warning: #9B6A2C;
      --danger: #A34848;

      --radius: 20px;
      --shadow: 0 16px 40px rgba(0,0,0,0.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .app{ max-width: 760px; margin: 0 auto; padding: 18px; }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{ display:grid; gap:12px; }
    .grid2{ grid-template-columns: 1fr 1fr; }

    .muted{ color: var(--muted); font-size: 13px; }
    .pill{
      display:inline-block;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.45);
      color: var(--text);
      font-weight: 700;
    }
    .ok{ color: var(--success); font-weight: 700; }
    .warn{ color: var(--warning); font-weight: 700; }
    .err{ color: var(--danger); font-weight: 700; }

    /* Header */
    .topbar{ display:grid; gap:10px; padding-bottom: 8px; text-align:center; }
    .brand{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 8px;
    }
    .title{
      margin:0;
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: clamp(32px, 6vw, 46px);
      letter-spacing: .3px;
      line-height: 1.05;
      color: var(--text);
    }
    .subtitle{
      margin:0;
      font-size: 14px;
      letter-spacing: 1.1px;
      color: var(--muted);
    }

    .mono{
      font-family: "Playfair Display", serif;
      font-size: 16px;
      letter-spacing: 1px;
      opacity: .85;
      user-select: none;
    }
    @media (max-width: 420px){
      .mono{ font-size: 14px; }
    }

    .topbar-actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Buttons */
    button{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--btnText);
      font-weight: 700;
      letter-spacing: .2px;
      cursor: pointer;
    }
    button:active{ transform: scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .smallbtn{
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 14px;
      width: auto;
    }

    .btn-subtle{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 650;
    }

    /* Camera */
    .camBox{
      position: relative;
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    }
    #camVideo, #camCanvas{
      width:100%;
      display:block;
      aspect-ratio: 3/4;
      object-fit: cover;
      background: rgba(0,0,0,0.04);
    }
    @media (min-width: 520px){
      #camVideo, #camCanvas{ aspect-ratio: 16/9; }
    }

    .flash{
      position:absolute; inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      transition: opacity 120ms ease;
    }
    .flash.on{ opacity: 0.85; }

    input[type="text"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }

    /* √âcran TABLE */
    #screenTable .section-title{
      text-align:center;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .3px;
      margin: 0 0 4px;
    }
    #tableButtons{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 14px;
      justify-items: center;
      margin-top: 6px;
    }
    #tableButtons button{
      width: 100%;
      max-width: 170px;
      padding: 16px 0;
      font-size: 16px;
      border-radius: 18px;
      background: var(--btn);
      border: 1px solid var(--btnBorder);
      color: var(--btnText);
      font-weight: 800;
    }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1.02); }
    }
    #tableButtons button.picked{
      animation: pop 220ms ease-out;
      background: #D6C4A6;
      border-color: var(--btnBorder);
    }

    .fade-in{ animation: fadeIn 220ms ease-out; }
    @keyframes fadeIn{
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .hr{ height:1px; background: var(--border); margin: 14px 0; opacity:.9; }

    /* Ic√¥ne flip */
    .flipIcon{
      display:inline-block;
      margin-right: 8px;
      transition: transform 260ms ease;
      transform-origin: 50% 50%;
    }
    .flipIcon.spin{ transform: rotate(180deg); }

    /* Cards list (d√©fis/escape) */
    .item{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.45);
      display: grid;
      gap: 8px;
    }
    .itemTitle{
      font-weight: 800;
      text-align: left;
      color: var(--text);
    }
    .itemDesc{
      font-size: 13px;
      color: var(--muted);
      text-align: left;
      line-height: 1.35;
    }
    .itemRow{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .tiny{ font-size: 12px; }

  </style>
</head>

<body>
  <div class="app">
    <div class="card">

      <header class="topbar">
        <div class="brand">
          <div class="mono">B &amp; A</div>
          <h1 class="title">10 ans</h1>
          <div class="mono">B &amp; A</div>
        </div>
        <p class="subtitle">‚ú® 2016 ‚Äì 2026 ‚ú®</p>

        <div class="topbar-actions">
          <div id="tableBadge" class="pill" style="display:none;"></div>
          <button id="resetBtn" class="smallbtn" style="display:none;">Changer de table</button>
        </div>
      </header>

      <!-- ECRANS -->
      <section id="screenTable" class="grid">
        <p class="section-title">Choisis ta table</p>
        <div id="tableButtons"></div>
        <p class="muted" style="text-align:center;margin:0;">Scanne le QR code, puis s√©lectionne ta table.</p>
      </section>

      <section id="screenMenu" class="grid">
        <button id="goPhoto">üì∏ Prendre une photo</button>
        <button id="goDefis">üéØ D√©fis photos</button>
        <button id="goEscape">üß© Escape game</button>

        <div class="pill" id="countPill">üì∑ Photos envoy√©es : 0</div>
        <div class="hr"></div>
        <p class="muted" style="text-align:center;margin:0;">Envoi automatique sur Drive.</p>
      </section>

      <section id="screenPhoto" class="grid">
        <p style="margin:0;text-align:center;font-weight:800;">Photobooth</p>

        <div class="grid">
          <div class="muted" style="text-align:center;">
            Type : <span id="typeLabel" class="pill">libre</span>
            <span id="missionPill" class="pill" style="display:none;margin-left:6px;"></span>
          </div>

          <div class="grid grid2">
            <button class="typeBtn" data-type="libre">üì∏ Libre</button>
            <button class="typeBtn" data-type="defi">üéØ D√©fi</button>
          </div>
          <button class="typeBtn" data-type="escape">üß© Escape</button>

          <div class="camBox">
            <video id="camVideo" playsinline autoplay muted></video>
            <canvas id="camCanvas" style="display:none;"></canvas>
            <div id="flash" class="flash"></div>
          </div>

          <div class="grid grid2">
            <button id="startCamBtn">üé• Activer la cam√©ra</button>
            <button id="switchCamBtn" class="btn-subtle">
              <span id="flipIcon" class="flipIcon">üîÑ</span><span id="switchCamText">Mode selfie</span>
            </button>
          </div>

          <div class="grid grid2">
            <button id="takePhotoBtn" disabled>üì∏ Prendre la photo</button>
            <button id="retakeBtn" style="display:none;" class="btn-subtle">üîÅ Reprendre</button>
          </div>

          <div id="sendStatus" class="muted" style="text-align:center;"></div>
          <p class="muted" style="text-align:center;margin:0;">Si la cam√©ra est bloqu√©e : Chrome ‚Üí cadenas üîí ‚Üí Autorisations ‚Üí Cam√©ra ‚Üí Autoriser.</p>

          <button id="backFromPhoto">‚¨ÖÔ∏è Retour</button>
        </div>
      </section>

      <section id="screenDefis" class="grid">
        <p style="text-align:center;margin:0;font-weight:800;">üéØ D√©fis photos</p>
        <p class="muted" style="text-align:center;margin:0;">Validez un d√©fi en prenant une photo.</p>

        <div class="pill" id="defisProgress" style="text-align:center;"></div>
        <div id="defisList" class="grid"></div>

        <button id="resetDefisBtn" class="btn-subtle">R√©initialiser les d√©fis</button>
        <button id="backFromDefis">‚¨ÖÔ∏è Retour menu</button>
      </section>

      <section id="screenEscape" class="grid">
        <p style="text-align:center;margin:0;font-weight:800;">üß© Escape game</p>
        <p class="muted" style="text-align:center;margin:0;">R√©ponds aux √©nigmes. Chaque bonne r√©ponse donne un chiffre.</p>

        <div class="pill" id="escapeProgress" style="text-align:center;"></div>
        <div id="enigmesList" class="grid"></div>

        <div class="hr"></div>
        <div id="finalBox" class="pill warn" style="text-align:center;">üîí Code final : pas encore‚Ä¶</div>

        <button id="resetEscapeBtn" class="btn-subtle">R√©initialiser l‚Äôescape</button>
        <button id="backFromEscape">‚¨ÖÔ∏è Retour menu</button>
      </section>

    </div>
  </div>

<script>
/** ========= CONFIG ========= */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdAYy5ZlgekOsJRBb9J8Q_-3b5KQggFC7CrwP2Yzqc65CtZmPKBLMzYEzUqw99j2Ax1Q/exec";

const TABLES = [
  { id: 1, name: "Table 1" },
  { id: 2, name: "Table 2" },
  { id: 3, name: "Table 3" },
  { id: 4, name: "Table 4" },
  { id: 5, name: "Table 5" },
  { id: 6, name: "Table 6" },
  { id: 7, name: "Table 7" },
  { id: 8, name: "Table 8" },
];

/* D√©fis : tu peux changer title/desc comme tu veux */
const DEFIS = [
  { id: "d1", title: "Tout le monde saute", desc: "Photo o√π tout le monde saute en m√™me temps." },
  { id: "d2", title: "La plus dr√¥le", desc: "Faites la photo la plus dr√¥le possible." },
  { id: "d3", title: "Couple (ou duo)", desc: "Photo en duo, pose styl√©e." },
  { id: "d4", title: "Objet rouge", desc: "Un objet rouge bien visible dans l‚Äôimage." },
  { id: "d5", title: "Sans sourire", desc: "Tout le monde s√©rieux üòê" },
];

/* Escape : chaque √©nigme donne un chiffre */
const ENIGMES = [
  { id: "e1", digit: "1", q: "Je suis plein de trous mais je retiens l‚Äôeau. Qui suis-je ?", a: "eponge" },
  { id: "e2", digit: "6", q: "Plus j‚Äôai de gardiens, moins je suis en s√©curit√©. Qui suis-je ?", a: "secret" },
  { id: "e3", digit: "1", q: "Je monte et je descends sans bouger. Qui suis-je ?", a: "escalier" },
  { id: "e4", digit: "2", q: "J'ai eu 5 de moyenne en fran√ßais. Qui suis-je ?", a: "nolan" }
];
const FINAL_CODE = (1612) => ENIGMES.map(e => e.digit).join("");

/** ========= STATE ========= */
const LS = {
  tableId: "bday_tableId",
  photoType: "bday_photoType",
  uploading: "bday_uploading",
  count: "bday_photo_count",
  camMode: "bday_cam_mode",
  mission: "bday_mission",          // { kind:"defi"|"escape"|"", id:"d1", title:"..." }
  defisDone: "bday_defis_done",     // { d1:true, ... }
  escapeOk: "bday_escape_ok",       // { e1:true, ... }
};

const $ = (id) => document.getElementById(id);
const screens = ["screenTable","screenMenu","screenPhoto","screenDefis","screenEscape"];

function setScreen(id){
  screens.forEach(s => $(s).style.display = (s === id ? "grid" : "none"));
  $(id).classList.add("fade-in");
  setTimeout(() => $(id).classList.remove("fade-in"), 260);
}

function getTableId(){ return Number(localStorage.getItem(LS.tableId) || 0); }
function setTableId(v){ localStorage.setItem(LS.tableId, String(v)); }

function getPhotoType(){ return localStorage.getItem(LS.photoType) || "libre"; }
function setPhotoType(v){ localStorage.setItem(LS.photoType, v); }

function getCount(){ return Number(localStorage.getItem(LS.count) || 0); }
function incCount(){
  localStorage.setItem(LS.count, String(getCount() + 1));
  updateCountUI();
}
function updateCountUI(){
  const el = $("countPill");
  if (el) el.textContent = `üì∑ Photos envoy√©es : ${getCount()}`;
}

function updateBadge(){
  const id = getTableId();
  const badge = $("tableBadge");
  const reset = $("resetBtn");
  if(!id){
    badge.style.display = "none";
    reset.style.display = "none";
    return;
  }
  const t = TABLES.find(x => x.id === id);
  badge.textContent = t ? `ü™ë ${t.name}` : `ü™ë Table ${id}`;
  badge.style.display = "inline-block";
  reset.style.display = "inline-block";
}

/** ========= Mission (d√©fi/escape) ========= */
function setMission(obj){
  localStorage.setItem(LS.mission, JSON.stringify(obj || null));
  updateMissionPill();
}
function getMission(){
  try { return JSON.parse(localStorage.getItem(LS.mission) || "null"); }
  catch { return null; }
}
function clearMission(){
  localStorage.removeItem(LS.mission);
  updateMissionPill();
}
function updateMissionPill(){
  const m = getMission();
  const pill = $("missionPill");
  if(!pill) return;

  if(m && m.title){
    pill.style.display = "inline-block";
    pill.textContent = `üéØ ${m.title}`;
  } else {
    pill.style.display = "none";
    pill.textContent = "";
  }
}

/** ========= D√©fis ========= */
function getDefisDone(){
  try { return JSON.parse(localStorage.getItem(LS.defisDone) || "{}"); }
  catch { return {}; }
}
function setDefisDone(obj){
  localStorage.setItem(LS.defisDone, JSON.stringify(obj));
}
function markDefiDone(defiId){
  const done = getDefisDone();
  done[defiId] = true;
  setDefisDone(done);
}
function resetDefis(){
  localStorage.removeItem(LS.defisDone);
}

/** ========= Escape ========= */
function normalize(s){
  return (s || "").toString().trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
}
function getEscapeOk(){
  try { return JSON.parse(localStorage.getItem(LS.escapeOk) || "{}"); }
  catch { return {}; }
}
function setEscapeOk(obj){
  localStorage.setItem(LS.escapeOk, JSON.stringify(obj));
}
function resetEscape(){
  localStorage.removeItem(LS.escapeOk);
}

/** ========= UI Tables ========= */
function renderTables(){
  const wrap = $("tableButtons");
  wrap.innerHTML = "";

  TABLES.forEach(t => {
    const btn = document.createElement("button");
    btn.textContent = t.name;

    btn.onclick = () => {
      btn.classList.add("picked");
      setTableId(t.id);
      updateBadge();
      setTimeout(() => setScreen("screenMenu"), 220);
    };

    wrap.appendChild(btn);
  });
}

/** ========= UI D√©fis ========= */
function renderDefis(){
  const done = getDefisDone();
  const wrap = $("defisList");
  wrap.innerHTML = "";

  const nbDone = DEFIS.filter(d => done[d.id]).length;
  $("defisProgress").textContent = `Progression : ${nbDone} / ${DEFIS.length} d√©fis`;

  DEFIS.forEach(d => {
    const isDone = !!done[d.id];

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemRow">
        <div>
          <div class="itemTitle">${isDone ? "‚úÖ" : "‚è≥"} ${d.title}</div>
          <div class="itemDesc">${d.desc}</div>
        </div>
        <div style="min-width:160px;">
          <button class="${isDone ? "btn-subtle" : ""}" data-action="do">
            ${isDone ? "Reprendre" : "üì∏ Faire ce d√©fi"}
          </button>
        </div>
      </div>
      <div class="muted tiny">${isDone ? "D√©fi valid√©" : "Appuie pour ouvrir l‚Äôappareil photo"}</div>
    `;

    div.querySelector("button").onclick = () => {
      // on lance une mission "d√©fi"
      setTypeUI("defi");
      setMission({ kind: "defi", id: d.id, title: d.title });
      setScreen("screenPhoto");
    };

    wrap.appendChild(div);
  });
}

/** ========= UI Escape ========= */
function renderEscape(){
  const ok = getEscapeOk();
  const wrap = $("enigmesList");
  wrap.innerHTML = "";

  const nbOk = ENIGMES.filter(e => ok[e.id]).length;
  $("escapeProgress").textContent = `Progression : ${nbOk} / ${ENIGMES.length} √©nigmes`;

  ENIGMES.forEach(e => {
    const isOk = !!ok[e.id];

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTitle">${isOk ? "‚úÖ" : "üß©"} √ânigme</div>
      <div class="itemDesc">${e.q}</div>
      <div class="grid grid2">
        <input type="text" id="ans_${e.id}" placeholder="Ta r√©ponse‚Ä¶" ${isOk ? "disabled" : ""}>
        <button id="btn_${e.id}" class="${isOk ? "btn-subtle" : ""}" ${isOk ? "disabled" : ""}>Valider</button>
      </div>
      <div class="muted tiny" id="st_${e.id}">${isOk ? `Chiffre obtenu : ${e.digit}` : ""}</div>
    `;

    wrap.appendChild(div);

    if(!isOk){
      div.querySelector(`#btn_${e.id}`).onclick = () => {
        const input = div.querySelector(`#ans_${e.id}`);
        const st = div.querySelector(`#st_${e.id}`);

        if(normalize(input.value) === normalize(e.a)){
          const next = getEscapeOk();
          next[e.id] = true;
          setEscapeOk(next);

          st.innerHTML = `<span class="ok">‚úÖ Correct ! Chiffre : ${e.digit}</span>`;
          renderEscape();
        } else {
          st.innerHTML = `<span class="err">‚ùå Mauvaise r√©ponse</span>`;
        }
      };
    }
  });

  const allOk = ENIGMES.every(e => getEscapeOk()[e.id]);
  const box = $("finalBox");
  if(allOk){
    box.className = "pill ok";
    box.textContent = `üîì Code final : ${FINAL_CODE()}`;
  } else {
    box.className = "pill warn";
    box.textContent = "üîí Code final : pas encore‚Ä¶";
  }
}

/** ========= Photo module ========= */
let camStream = null;
let capturedDataUrl = null;

let cameraMode = localStorage.getItem(LS.camMode) || "environment"; // "environment" | "user"

function updateSwitchCamUI(){
  const txt = $("switchCamText");
  if (!txt) return;
  txt.textContent = (cameraMode === "user") ? "Cam√©ra arri√®re" : "Mode selfie";
}
function spinFlipIcon(){
  const icon = $("flipIcon");
  if(!icon) return;
  icon.classList.toggle("spin");
  setTimeout(() => icon.classList.toggle("spin"), 280);
}

function flash(){
  const f = $("flash");
  if(!f) return;
  f.classList.add("on");
  setTimeout(() => f.classList.remove("on"), 140);
}
function haptic(){ if (navigator.vibrate) navigator.vibrate(30); }
function clickSound(){
  try{
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return;
    const ctx = new Ctx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.value = 1200;
    g.gain.value = 0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(() => { o.stop(); ctx.close(); }, 80);
  } catch {}
}

function setTypeUI(t){
  setPhotoType(t);
  $("typeLabel").textContent = t;
}

async function startCamera(){
  try{
    $("sendStatus").textContent = "üé• Activation cam√©ra‚Ä¶";

    if (camStream) {
      camStream.getTracks().forEach(tr => tr.stop());
      camStream = null;
    }

    camStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: cameraMode,
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    $("camVideo").srcObject = camStream;
    $("takePhotoBtn").disabled = false;
    $("sendStatus").textContent = "";
  } catch(e){
    $("sendStatus").innerHTML = `<span class="err">‚ùå Cam√©ra refus√©e. Autorise-la via le cadenas üîí.</span>`;
  }
}

function stopCamera(){
  if(camStream){
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  $("camVideo").srcObject = null;
  $("takePhotoBtn").disabled = true;
}

function takePhoto(){
  const video = $("camVideo");
  const canvas = $("camCanvas");
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;

  canvas.width = w;
  canvas.height = h;
  canvas.getContext("2d").drawImage(video, 0, 0, w, h);

  capturedDataUrl = canvas.toDataURL("image/jpeg", 0.8);

  flash(); haptic(); clickSound();

  $("sendStatus").innerHTML = `<span class="muted">üì§ Envoi automatique‚Ä¶</span>`;
  $("retakeBtn").style.display = "block";

  setTimeout(() => sendPhotoAuto(), 200);
}

async function sendPhotoAuto(){
  const tableId = getTableId();
  if(!tableId){
    $("sendStatus").innerHTML = `<span class="err">Choisis d‚Äôabord une table.</span>`;
    setScreen("screenTable");
    return;
  }
  if(!capturedDataUrl){
    $("sendStatus").innerHTML = `<span class="warn">Aucune photo captur√©e.</span>`;
    return;
  }
  if(!APPS_SCRIPT_URL || !APPS_SCRIPT_URL.includes("/exec")){
    $("sendStatus").innerHTML = `<span class="err">URL Apps Script invalide.</span>`;
    return;
  }
  if (localStorage.getItem(LS.uploading) === "1") return;
  localStorage.setItem(LS.uploading, "1");

  const mission = getMission(); // pour marquer un d√©fi apr√®s upload

  try{
    const payload = {
      tableId,
      type: getPhotoType(),
      filename: `table${tableId}_${getPhotoType()}_${Date.now()}.jpg`,
      dataUrl: capturedDataUrl,

      // m√©tadonn√©es (optionnelles, Apps Script peut ignorer)
      mission: mission || null,
    };

    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });

    incCount();

    // ‚úÖ Si c'√©tait un d√©fi, on le marque ‚Äúfait‚Äù
    if(mission && mission.kind === "defi" && mission.id){
      markDefiDone(mission.id);
    }

    $("sendStatus").innerHTML = `<span class="ok">‚úÖ Photo envoy√©e üéâ</span>`;
    capturedDataUrl = null;
    $("retakeBtn").style.display = "none";

    // retour intelligent : si mission d√©fi ‚Üí retour d√©fis, sinon menu
    const target = (mission && mission.kind === "defi") ? "screenDefis" : "screenMenu";
    clearMission();

    setTimeout(() => {
      if(target === "screenDefis") renderDefis();
      setScreen(target);
    }, 900);

  } catch(e){
    $("sendStatus").innerHTML = `<span class="err">‚ùå Erreur r√©seau. V√©rifie la connexion.</span>`;
  } finally {
    setTimeout(() => localStorage.removeItem(LS.uploading), 800);
  }
}

function resetPhotoSession(){
  capturedDataUrl = null;
  $("sendStatus").textContent = "";
  $("retakeBtn").style.display = "none";
  updateMissionPill();
}

/** ========= INIT + NAV ========= */
document.addEventListener("DOMContentLoaded", () => {
  screens.forEach(s => $(s).style.display = "none");

  renderTables();
  updateBadge();
  updateCountUI();
  setTypeUI(getPhotoType());
  updateSwitchCamUI();
  updateMissionPill();

  if(!getTableId()) setScreen("screenTable");
  else setScreen("screenMenu");

  // Menu
  $("goPhoto").onclick = () => {
    clearMission();
    resetPhotoSession();
    setScreen("screenPhoto");
  };

  $("goDefis").onclick = () => {
    renderDefis();
    setScreen("screenDefis");
  };

  $("goEscape").onclick = () => {
    renderEscape();
    setScreen("screenEscape");
  };

  // Back
  $("backFromDefis").onclick = () => setScreen("screenMenu");
  $("backFromEscape").onclick = () => setScreen("screenMenu");

  $("backFromPhoto").onclick = () => {
    stopCamera();
    // si photo lanc√©e depuis un d√©fi, on retourne aux d√©fis
    const m = getMission();
    if(m && m.kind === "defi"){ renderDefis(); setScreen("screenDefis"); }
    else setScreen("screenMenu");
  };

  // Reset table
  $("resetBtn").onclick = () => {
    setTableId(0);
    updateBadge();
    setScreen("screenTable");
  };

  // Reset defis/escape
  $("resetDefisBtn").onclick = () => { resetDefis(); renderDefis(); };
  $("resetEscapeBtn").onclick = () => { resetEscape(); renderEscape(); };

  // Type buttons (manuel)
  document.querySelectorAll(".typeBtn").forEach(btn => {
    btn.onclick = () => {
      clearMission();
      setTypeUI(btn.dataset.type);
      updateMissionPill();
    };
  });

  // camera controls
  $("startCamBtn").onclick = startCamera;
  $("takePhotoBtn").onclick = takePhoto;

  $("switchCamBtn").onclick = () => {
    cameraMode = (cameraMode === "environment") ? "user" : "environment";
    localStorage.setItem(LS.camMode, cameraMode);
    spinFlipIcon();
    updateSwitchCamUI();
    if (camStream) startCamera();
  };

  $("retakeBtn").onclick = () => {
    capturedDataUrl = null;
    $("sendStatus").innerHTML = `<span class="muted">üì∏ Reprends la photo</span>`;
  };
});
</script>
</body>
</html>
