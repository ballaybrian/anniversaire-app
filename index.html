<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>10 ans ‚Äì B & A</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F3EBDD;
      --card: rgba(255,255,255,0.62);
      --border:#D9CDBA;

      --text:#5F7A68;
      --muted:rgba(95,122,104,0.70);

      --btn:#8aa685;
      --btnText:#fff;
      --btnBorder:#6f8f6a;

      --success:#3F7C5A;
      --warning:#9B6A2C;
      --danger:#A34848;

      --radius:20px;
      --shadow:0 16px 40px rgba(0,0,0,0.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .app{ max-width: 760px; margin: 0 auto; padding: 18px; }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{ display:grid; gap:12px; }
    .grid2{ grid-template-columns: 1fr 1fr; }

    .muted{ color: var(--muted); font-size: 13px; }
    .pill{
      display:inline-block;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.45);
      color: var(--text);
      font-weight: 800;
    }
    .ok{ color: var(--success); font-weight: 800; }
    .warn{ color: var(--warning); font-weight: 800; }
    .err{ color: var(--danger); font-weight: 800; }

    .topbar{ display:grid; gap:10px; padding-bottom: 8px; text-align:center; }
    .brand{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 8px;
    }
    .title{
      margin:0;
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: clamp(32px, 6vw, 46px);
      letter-spacing: .3px;
      line-height: 1.05;
    }
    .subtitle{
      margin:0;
      font-size: 14px;
      letter-spacing: 1.1px;
      color: var(--muted);
    }
    .mono{
      font-family: "Playfair Display", serif;
      font-size: 16px;
      letter-spacing: 1px;
      opacity: .85;
      user-select: none;
    }
    .topbar-actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    button{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--btnText);
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
    }
    button:active{ transform: scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .smallbtn{
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 14px;
      width: auto;
      font-weight: 900;
    }
    .btn-subtle{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 800;
    }

    .hr{ height:1px; background: var(--border); margin: 14px 0; opacity:.9; }

    section[data-screen]{ display:none; }
    .fade-in{ animation: fadeIn 220ms ease-out; }
    @keyframes fadeIn{
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #tableButtons{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      justify-items:center;
      margin-top: 6px;
    }
    #tableButtons button{
      width:100%;
      max-width:170px;
      padding: 16px 0;
      font-size: 16px;
      border-radius: 18px;
      font-weight: 900;
    }
    @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1.02)} }
    #tableButtons button.picked{ animation: pop 220ms ease-out; filter: brightness(1.03); }

    .menuBlock{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.45);
      text-align: left;
    }
    .menuTitle{ font-weight: 900; margin: 0 0 8px; }
    .menuText{
      border: 1px dashed rgba(95,122,104,0.35);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.35);
      color: rgba(95,122,104,0.92);
      line-height: 1.35;
      white-space: pre-wrap;
      min-height: 54px;
    }

    /* Galerie interne */
    .galleryGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (min-width: 520px){
      .galleryGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    .thumb{
      width:100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.35);
      cursor: pointer;
    }
    .viewer{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.86);
      z-index: 9999;
      display:none;
      padding: 14px;
    }
    .viewerTop{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      max-width: 980px;
      margin: 0 auto;
    }
    .viewerImg{
      display:block;
      width: 100%;
      height: calc(100% - 120px);
      max-width: 980px;
      margin: 12px auto 0;
      object-fit: contain;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
    }

    .camBox{
      position: relative;
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 12px 26px rgba(0,0,0,0.08);
    }
    #camVideo, #camCanvas{
      width:100%;
      display:block;
      aspect-ratio: 3/4;
      object-fit: cover;
      background: rgba(0,0,0,0.04);
    }
    @media (min-width: 520px){
      #camVideo, #camCanvas{ aspect-ratio: 16/9; }
    }
    .flash{
      position:absolute; inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      transition: opacity 120ms ease;
    }
    .flash.on{ opacity: 0.85; }

    .flipIcon{
      display:inline-block;
      margin-right: 8px;
      transition: transform 260ms ease;
      transform-origin: 50% 50%;
    }
    .flipIcon.spin{ transform: rotate(180deg); }

    .item{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.45);
      display: grid;
      gap: 8px;
    }
    .itemTitle{ font-weight: 900; }
    .itemDesc{ font-size: 13px; color: var(--muted); line-height: 1.35; }
    .itemRow{ display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    .tiny{ font-size: 12px; }

    input[type="text"], input[type="number"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }

    .progressWrap{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.45);
      border-radius: 999px;
      padding: 10px 10px 8px;
    }
    .progressBar{
      height: 12px;
      border-radius: 999px;
      background: rgba(95,122,104,0.20);
      overflow: hidden;
    }
    .progressFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: var(--text);
      transition: width 260ms ease;
    }
    .progressLabel{
      margin-top: 8px;
      text-align: center;
      font-weight: 900;
      color: var(--text);
      letter-spacing: .3px;
    }
    .progressSub{
      margin-top: 2px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    #bAdminReset { display:none; }
    #bAdminReset.show { display:block; }
  </style>
</head>

<body>
  <div class="app">
    <div class="card">

      <header class="topbar" id="brandHold">
        <div class="brand">
          <div class="mono">B &amp; A</div>
          <h1 class="title">10 ans</h1>
          <div class="mono">B &amp; A</div>
        </div>
        <p class="subtitle">‚ú® 2016 ‚Äì 2026 ‚ú®</p>

        <div class="topbar-actions">
          <div id="tableBadge" class="pill" style="display:none;"></div>
          <button id="resetBtn" class="smallbtn" style="display:none;">Changer de table</button>
        </div>
      </header>

      <!-- ACCUEIL -->
      <section id="screenHome" data-screen class="grid">
        <button id="homeTable">ü™ë Table</button>
        <button id="homeMenu">üçΩÔ∏è Menu</button>
        <button id="homeAlbum">üñºÔ∏è Voir photo</button>
        <button id="homeGames">üéâ Jeux &amp; Photos</button>

        <div class="pill" id="countPill">üì∑ Photos envoy√©es : 0</div>
        <div class="hr"></div>
        <p class="muted" style="text-align:center;margin:0;">Envoi automatique sur Drive.</p>
      </section>

      <!-- TABLE -->
      <section id="screenTable" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">Choisis ta table</p>
        <div id="tableButtons"></div>
        <p class="muted" style="text-align:center;margin:0;">Apr√®s s√©lection, tu reviens √† l‚Äôaccueil.</p>
        <button id="backFromTable" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- MENU -->
      <section id="screenMenu" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üçΩÔ∏è Menu</p>
        <p class="muted" style="text-align:center;margin:0;">(Texte d√©fini dans le code ‚Äî non modifiable)</p>

        <div class="menuBlock">
          <p class="menuTitle">Entr√©e</p>
          <div id="menuEntree" class="menuText"></div>
        </div>
        <div class="menuBlock">
          <p class="menuTitle">Plat</p>
          <div id="menuPlat" class="menuText"></div>
        </div>
        <div class="menuBlock">
          <p class="menuTitle">Fromage</p>
          <div id="menuFromage" class="menuText"></div>
        </div>

        <button id="backFromMenu" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- ALBUM (galerie interne) -->
      <section id="screenAlbum" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üñºÔ∏è Album photo</p>
        <p class="muted" style="text-align:center;margin:0;">Galerie interne (lecture seule).</p>

        <div class="grid grid2">
          <button id="refreshGallery" class="btn-subtle">üîÑ Actualiser</button>
          <button id="openDriveAlbum" class="btn-subtle">üìÇ Ouvrir sur Drive</button>
        </div>

        <div id="galleryStatus" class="muted" style="text-align:center;"></div>
        <div id="gallery" class="galleryGrid"></div>

        <p class="muted" style="text-align:center;margin:0;">
          Si les images ne chargent pas : dossier Drive ‚Üí partage ‚ÄúToute personne avec le lien peut voir‚Äù.
        </p>

        <button id="backFromAlbum" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- VIEWER plein √©cran + swipe -->
      <div id="viewer" class="viewer">
        <div class="viewerTop">
          <button id="closeViewer" class="btn-subtle" style="max-width:160px;">‚úñ Fermer</button>
          <div id="viewerName" class="pill" style="max-width:60%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
        </div>
        <img id="viewerImg" class="viewerImg" alt="Photo">
        <div style="max-width:980px;margin:10px auto 0;display:flex;gap:10px;justify-content:space-between;">
          <button id="prevPhoto" class="btn-subtle" style="max-width:160px;">‚óÄ</button>
          <button id="nextPhoto" class="btn-subtle" style="max-width:160px;">‚ñ∂</button>
        </div>
      </div>

      <!-- JEUX -->
      <section id="screenGames" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üéâ Jeux &amp; Photos</p>
        <button id="goPhoto">üì∏ Prendre une photo</button>
        <button id="goDefis">üéØ D√©fis photos</button>
        <button id="goCodeGame">üîê Code Game</button>
        <button id="goBouchons">üçæ Combien de bouchons ?</button>
        <button id="backFromGames" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- PHOTO -->
      <section id="screenPhoto" data-screen class="grid">
        <p style="margin:0;text-align:center;font-weight:900;">Photobooth</p>

        <div class="muted" style="text-align:center;">
          Type : <span id="typeLabel" class="pill">libre</span>
          <span id="missionPill" class="pill" style="display:none;margin-left:6px;"></span>
        </div>

        <div class="grid grid2">
          <button class="typeBtn" data-type="libre">üì∏ Libre</button>
          <button class="typeBtn" data-type="defi">üéØ D√©fi</button>
        </div>
        <button class="typeBtn" data-type="codegame">üîê Code Game</button>

        <div class="camBox">
          <video id="camVideo" playsinline autoplay muted></video>
          <canvas id="camCanvas" style="display:none;"></canvas>
          <div id="flash" class="flash"></div>
        </div>

        <div class="grid grid2">
          <button id="startCamBtn">üé• Activer la cam√©ra</button>
          <button id="switchCamBtn" class="btn-subtle">
            <span id="flipIcon" class="flipIcon">üîÑ</span><span id="switchCamText">Mode selfie</span>
          </button>
        </div>

        <div class="grid grid2">
          <button id="takePhotoBtn" disabled>üì∏ Prendre la photo</button>
          <button id="retakeBtn" style="display:none;" class="btn-subtle">üîÅ Reprendre</button>
        </div>

        <div id="sendStatus" class="muted" style="text-align:center;"></div>

        <button id="backFromPhoto" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- DEFIS -->
      <section id="screenDefis" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üéØ D√©fis photos</p>
        <p class="muted" style="text-align:center;margin:0;">Validez un d√©fi en prenant une photo.</p>

        <div class="progressWrap">
          <div class="progressBar"><div id="defisFill" class="progressFill"></div></div>
          <div id="defisPercent" class="progressLabel">0%</div>
          <div id="defisSub" class="progressSub">0 / 0 d√©fis</div>
        </div>

        <div id="defisList" class="grid"></div>

        <button id="resetDefisBtn" class="btn-subtle">R√©initialiser les d√©fis</button>
        <button id="backFromDefis" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- CODE GAME (‚úÖ r√®gles + chiffres r√©v√©l√©s, ‚ùå plus de "code final") -->
      <section id="screenCodeGame" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üîê Code Game</p>

        <div class="menuBlock">
          <p class="menuTitle">R√®gles &amp; r√©compense</p>
          <div id="codeRules" class="menuText"></div>
        </div>

        <div class="progressWrap">
          <div class="progressBar"><div id="codeFill" class="progressFill"></div></div>
          <div id="codePercent" class="progressLabel">0%</div>
          <div id="codeSub" class="progressSub">0 / 0 √©nigmes</div>
        </div>

        <div id="enigmesList" class="grid"></div>

        <button id="resetCodeBtn" class="btn-subtle">R√©initialiser le Code Game</button>
        <button id="backFromCode" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

      <!-- BOUCHONS -->
      <section id="screenBouchons" data-screen class="grid">
        <p style="text-align:center;margin:0;font-weight:900;">üçæ Combien de bouchons ?</p>
        <p class="muted" style="text-align:center;margin:0;">Trouve le bon nombre. Le jeu se bloque d√®s qu‚Äôun gagnant trouve.</p>

        <div class="item">
          <div class="itemTitle">Ta proposition</div>
          <div class="grid grid2">
            <input id="bGuess" type="number" min="0" step="1">
            <button id="bSubmit">Valider</button>
          </div>

          <div id="bHint" class="pill" style="text-align:center; display:none;"></div>

          <div style="margin-top:10px;">
            <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:900; color:rgba(95,122,104,0.75);">
              <span>üßä Loin</span>
              <span>üî• Proche</span>
            </div>
            <div style="margin-top:6px; height:14px; border-radius:999px; overflow:hidden; border:1px solid var(--border); background:rgba(255,255,255,0.45);">
              <div id="bThermoFill" style="height:100%; width:0%; border-radius:999px; transition: width 260ms ease, background-color 260ms ease;"></div>
            </div>
            <div id="bThermoText" class="muted tiny" style="text-align:center; margin-top:6px;"></div>
          </div>

          <div id="bStatus" class="muted tiny" style="margin-top:8px;"></div>

          <button id="bAdminReset" class="btn-subtle">üîÅ R√©initialiser le jeu (ADMIN)</button>
        </div>

        <div class="item">
          <div class="itemTitle">√âtat du jeu</div>
          <div id="bLockInfo" class="muted">Chargement‚Ä¶</div>
        </div>

        <button id="backFromBouchons" class="btn-subtle">‚¨ÖÔ∏è Retour</button>
      </section>

    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRnt-PAf31mmcNUWThZQHyMgW7Fwl94LY-Sn3iiUOnZjBJiIVCidodBFt3T0wVAZizNQ/exec";
const DRIVE_ALBUM_FOLDER_ID = "1tABmop6f2NpJzeTJH4Xs8zesvax_h-eI";

/* ‚úÖ Menu (tu modifies ici) */
const MENU_ENTREE  = `√Ä compl√©ter‚Ä¶`;
const MENU_PLAT    = `√Ä compl√©ter‚Ä¶`;
const MENU_FROMAGE = `√Ä compl√©ter‚Ä¶`;

/* ‚úÖ Code Game ‚Äì r√®gles & r√©compense (tu modifies ici) */
const CODEGAME_RULES = `R√àGLES :
- R√©sous les √©nigmes pour r√©v√©ler un chiffre √† chaque fois.
- √Ä la fin, assemble les chiffres pour ouvrir le cadenas.

R√âCOMPENSE :
üéÅ √Ä compl√©ter‚Ä¶`;

/* Tables */
const TABLES = [
  { id: 1, name: "Table 1" }, { id: 2, name: "Table 2" }, { id: 3, name: "Table 3" },
  { id: 4, name: "Table 4" }, { id: 5, name: "Table 5" }, { id: 6, name: "Table 6" },
  { id: 7, name: "Table 7" }, { id: 8, name: "Table 8" }, { id: 9, name: "Table 9" },
];

/* D√©fis */
const DEFIS = [
  { id: "d1", title: "Tout le monde saute", desc: "Photo o√π tout le monde saute en m√™me temps." },
  { id: "d2", title: "La plus dr√¥le", desc: "Faites la photo la plus dr√¥le possible." },
  { id: "d3", title: "Couple (ou duo)", desc: "Photo en duo, pose styl√©e." },
  { id: "d4", title: "Objet rouge", desc: "Un objet rouge bien visible dans l‚Äôimage." },
  { id: "d5", title: "Sans sourire", desc: "Tout le monde s√©rieux üòê" },
];

/* ‚úÖ Code Game : chaque √©nigme r√©v√®le un chiffre */
const ENIGMES = [
  { id: "e1", q: "Je suis plein de trous mais je retiens l‚Äôeau. Qui suis-je ?", a: "eponge", digit: "9" },
  { id: "e2", q: "Plus j‚Äôai de gardiens, moins je suis en s√©curit√©. Qui suis-je ?", a: "secret", digit: "0" },
  { id: "e3", q: "Je monte et je descends sans bouger. Qui suis-je ?", a: "escalier", digit: "4" },
  { id: "e4", q: "j'ai eu que 5 de moyen en Fran√ßais. Qui suis-je ?", a: "nolan", digit: "2" }
];

/* LocalStorage */
const LS = {
  tableId: "bday_tableId",
  photoType: "bday_photoType",
  uploading: "bday_uploading",
  count: "bday_photo_count",
  camMode: "bday_cam_mode",
  mission: "bday_mission",
  defisDone: "bday_defis_done",
  codeOk: "bday_code_ok",
};

const $ = (id) => document.getElementById(id);

/* ================= NAV ================= */
const screenEls = () => Array.from(document.querySelectorAll("[data-screen]"));
function setScreen(id){
  for(const el of screenEls()) el.style.display = "none";
  const target = $(id);
  if(!target) return;
  target.style.display = "grid";
  target.classList.add("fade-in");
  setTimeout(() => target.classList.remove("fade-in"), 260);
}

/* ================= COMMON ================= */
function getTableId(){ return Number(localStorage.getItem(LS.tableId) || 0); }
function setTableId(v){ localStorage.setItem(LS.tableId, String(v)); }

function getCount(){ return Number(localStorage.getItem(LS.count) || 0); }
function incCount(){ localStorage.setItem(LS.count, String(getCount() + 1)); updateCountUI(); }
function updateCountUI(){ $("countPill").textContent = `üì∑ Photos envoy√©es : ${getCount()}`; }

function updateBadge(){
  const id = getTableId();
  const badge = $("tableBadge");
  const reset = $("resetBtn");
  if(!id){ badge.style.display="none"; reset.style.display="none"; return; }
  const t = TABLES.find(x => x.id === id);
  badge.textContent = t ? `ü™ë ${t.name}` : `ü™ë Table ${id}`;
  badge.style.display="inline-block";
  reset.style.display="inline-block";
}

function renderMenu(){
  $("menuEntree").textContent  = MENU_ENTREE;
  $("menuPlat").textContent    = MENU_PLAT;
  $("menuFromage").textContent = MENU_FROMAGE;
}

/* ================= TABLE ================= */
function renderTables(){
  const wrap = $("tableButtons");
  wrap.innerHTML = "";
  TABLES.forEach(t => {
    const btn = document.createElement("button");
    btn.textContent = t.name;
    btn.onclick = () => {
      btn.classList.add("picked");
      setTableId(t.id);
      updateBadge();
      setTimeout(() => setScreen("screenHome"), 220);
    };
    wrap.appendChild(btn);
  });
}

/* ================= PROGRESS ================= */
function setProgress(fillEl, percentEl, subEl, done, total, label){
  const pct = total ? Math.round((done/total)*100) : 0;
  fillEl.style.width = pct + "%";
  percentEl.textContent = pct + "%";
  subEl.textContent = `${done} / ${total} ${label}`;
}

/* ================= DEFIS ================= */
function getDefisDone(){ try { return JSON.parse(localStorage.getItem(LS.defisDone) || "{}"); } catch { return {}; } }
function setDefisDone(obj){ localStorage.setItem(LS.defisDone, JSON.stringify(obj)); }
function markDefiDone(id){ const d = getDefisDone(); d[id] = true; setDefisDone(d); }
function resetDefis(){ localStorage.removeItem(LS.defisDone); }

function setMission(obj){ localStorage.setItem(LS.mission, JSON.stringify(obj || null)); updateMissionPill(); }
function getMission(){ try { return JSON.parse(localStorage.getItem(LS.mission) || "null"); } catch { return null; } }
function clearMission(){ localStorage.removeItem(LS.mission); updateMissionPill(); }

function updateMissionPill(){
  const m = getMission();
  const pill = $("missionPill");
  if(m && m.title){
    pill.style.display = "inline-block";
    pill.textContent = `üéØ ${m.title}`;
  } else {
    pill.style.display = "none";
    pill.textContent = "";
  }
}

function setPhotoType(v){ localStorage.setItem(LS.photoType, v); }
function getPhotoType(){ return localStorage.getItem(LS.photoType) || "libre"; }
function setTypeUI(t){
  setPhotoType(t);
  $("typeLabel").textContent = (t === "codegame") ? "code game" : t;
}

function renderDefis(){
  const done = getDefisDone();
  const wrap = $("defisList");
  wrap.innerHTML = "";

  const nbDone = DEFIS.filter(d => done[d.id]).length;
  setProgress($("defisFill"), $("defisPercent"), $("defisSub"), nbDone, DEFIS.length, "d√©fis");

  DEFIS.forEach(d => {
    const isDone = !!done[d.id];
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemRow">
        <div>
          <div class="itemTitle">${isDone ? "‚úÖ" : "‚è≥"} ${d.title}</div>
          <div class="itemDesc">${d.desc}</div>
        </div>
        <div style="min-width:160px;">
          <button class="${isDone ? "btn-subtle" : ""}">${isDone ? "Reprendre" : "üì∏ Faire ce d√©fi"}</button>
        </div>
      </div>
      <div class="muted tiny">${isDone ? "D√©fi valid√©" : "Appuie pour ouvrir l‚Äôappareil photo"}</div>
    `;
    div.querySelector("button").onclick = () => {
      setTypeUI("defi");
      setMission({ kind:"defi", id:d.id, title:d.title });
      setScreen("screenPhoto");
    };
    wrap.appendChild(div);
  });
}

/* ================= CODE GAME ================= */
function normalize(s){
  return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
}
function getCodeOk(){ try { return JSON.parse(localStorage.getItem(LS.codeOk) || "{}"); } catch { return {}; } }
function setCodeOk(obj){ localStorage.setItem(LS.codeOk, JSON.stringify(obj)); }
function resetCodeGame(){ localStorage.removeItem(LS.codeOk); }

function renderCodeGame(){
  $("codeRules").textContent = CODEGAME_RULES;

  const ok = getCodeOk();
  const wrap = $("enigmesList");
  wrap.innerHTML = "";

  const nbOk = ENIGMES.filter(e => ok[e.id]).length;
  setProgress($("codeFill"), $("codePercent"), $("codeSub"), nbOk, ENIGMES.length, "√©nigmes");

  ENIGMES.forEach(e => {
    const isOk = !!ok[e.id];
    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
      <div class="itemTitle">${isOk ? "‚úÖ" : "üîê"} √ânigme</div>
      <div class="itemDesc">${e.q}</div>

      <div class="grid grid2">
        <input type="text" id="ans_${e.id}" placeholder="Ta r√©ponse‚Ä¶" ${isOk ? "disabled" : ""}>
        <button id="btn_${e.id}" class="${isOk ? "btn-subtle" : ""}" ${isOk ? "disabled" : ""}>Valider</button>
      </div>

      <div class="muted tiny" id="st_${e.id}">
        ${isOk ? `üéâ Chiffre r√©v√©l√© : <span class="ok">${e.digit}</span>` : ""}
      </div>
    `;
    wrap.appendChild(div);

    if(!isOk){
      div.querySelector(`#btn_${e.id}`).onclick = () => {
        const input = div.querySelector(`#ans_${e.id}`);
        const st = div.querySelector(`#st_${e.id}`);

        if(normalize(input.value) === normalize(e.a)){
          const next = getCodeOk();
          next[e.id] = true;
          setCodeOk(next);

          st.innerHTML = `üéâ Chiffre r√©v√©l√© : <span class="ok">${e.digit}</span>`;
          renderCodeGame();
        } else {
          st.innerHTML = `<span class="err">‚ùå Mauvaise r√©ponse</span>`;
        }
      };
    }
  });
}

/* ================= PHOTO ================= */
let camStream = null;
let capturedDataUrl = null;
let cameraMode = localStorage.getItem(LS.camMode) || "environment";

function updateSwitchCamUI(){
  $("switchCamText").textContent = (cameraMode === "user") ? "Cam√©ra arri√®re" : "Mode selfie";
}
function spinFlipIcon(){
  $("flipIcon").classList.toggle("spin");
  setTimeout(() => $("flipIcon").classList.toggle("spin"), 280);
}
function flash(){
  $("flash").classList.add("on");
  setTimeout(() => $("flash").classList.remove("on"), 140);
}

async function startCamera(){
  try{
    $("sendStatus").textContent = "üé• Activation cam√©ra‚Ä¶";
    if (camStream) camStream.getTracks().forEach(tr => tr.stop());
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: cameraMode, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    $("camVideo").srcObject = camStream;
    $("takePhotoBtn").disabled = false;
    $("sendStatus").textContent = "";
  } catch(e){
    $("sendStatus").innerHTML = `<span class="err">‚ùå Cam√©ra refus√©e. Autorise-la via le cadenas üîí.</span>`;
  }
}
function stopCamera(){
  if(camStream){ camStream.getTracks().forEach(t => t.stop()); camStream = null; }
  $("camVideo").srcObject = null;
  $("takePhotoBtn").disabled = true;
}
function takePhoto(){
  const video = $("camVideo");
  const canvas = $("camCanvas");
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  canvas.getContext("2d").drawImage(video, 0, 0, w, h);
  capturedDataUrl = canvas.toDataURL("image/jpeg", 0.8);
  flash();
  $("sendStatus").innerHTML = `<span class="muted">üì§ Envoi automatique‚Ä¶</span>`;
  $("retakeBtn").style.display = "block";
  setTimeout(sendPhotoAuto, 200);
}

async function sendPhotoAuto(){
  const tableId = getTableId();
  if(!tableId){
    $("sendStatus").innerHTML = `<span class="err">Choisis d‚Äôabord une table.</span>`;
    setScreen("screenTable");
    return;
  }
  if(!capturedDataUrl) return;

  if (localStorage.getItem(LS.uploading) === "1") return;
  localStorage.setItem(LS.uploading, "1");

  const mission = getMission();

  try{
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        tableId,
        type: getPhotoType(),
        filename: `table${tableId}_${getPhotoType()}_${Date.now()}.jpg`,
        dataUrl: capturedDataUrl,
        mission: mission || null,
      }),
    });

    incCount();

    if(mission && mission.kind === "defi" && mission.id){
      markDefiDone(mission.id);
    }

    $("sendStatus").innerHTML = `<span class="ok">‚úÖ Photo envoy√©e üéâ</span>`;
    capturedDataUrl = null;
    $("retakeBtn").style.display = "none";
    clearMission();

    setTimeout(() => setScreen("screenGames"), 900);

  } catch(e){
    $("sendStatus").innerHTML = `<span class="err">‚ùå Erreur r√©seau.</span>`;
  } finally {
    setTimeout(() => localStorage.removeItem(LS.uploading), 800);
  }
}

/* ================= ALBUM INTERNE + VIEWER (swipe) ================= */
let albumItems = [];
let viewerIndex = -1;

async function loadGallery(){
  $("galleryStatus").textContent = "Chargement des photos‚Ä¶";
  $("gallery").innerHTML = "";
  albumItems = [];

  try{
    const url = `${APPS_SCRIPT_URL}?action=album_list&folderId=${encodeURIComponent(DRIVE_ALBUM_FOLDER_ID)}&t=${Date.now()}`;
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const data = await res.json();

    if(!data.ok){
      $("galleryStatus").innerHTML = `<span class="err">${data.message || "Erreur galerie"}</span>`;
      return;
    }

    const items = Array.isArray(data.items) ? data.items : [];
    albumItems = items;

    if(items.length === 0){
      $("galleryStatus").textContent = "Aucune photo pour le moment.";
      return;
    }

    $("galleryStatus").textContent = `${items.length} photo(s)`;

    items.forEach((it) => {
      const img = document.createElement("img");
      img.className = "thumb";
      img.loading = "lazy";
      img.src = it.imgUrl;
      img.alt = it.name || "photo";
      img.onclick = () => openViewer(it);
      $("gallery").appendChild(img);
    });

  } catch(e){
    $("galleryStatus").innerHTML = `<span class="err">Erreur de chargement (droits Drive ?)</span>`;
  }
}

function openViewer(it){
  viewerIndex = albumItems.findIndex(x => x.id === it.id);
  if(viewerIndex < 0) viewerIndex = 0;
  renderViewer();
  $("viewer").style.display = "block";
}

function renderViewer(){
  const it = albumItems[viewerIndex];
  if(!it) return;
  $("viewerImg").src = it.imgUrl;
  $("viewerName").textContent = it.name || "";
  $("prevPhoto").disabled = (viewerIndex <= 0);
  $("nextPhoto").disabled = (viewerIndex >= albumItems.length - 1);
}

function closeViewer(){
  $("viewer").style.display = "none";
  $("viewerImg").src = "";
  $("viewerName").textContent = "";
  viewerIndex = -1;
}

function prevViewer(){
  if(viewerIndex > 0){ viewerIndex--; renderViewer(); }
}
function nextViewer(){
  if(viewerIndex < albumItems.length - 1){ viewerIndex++; renderViewer(); }
}

/* ================= BOUCHONS ================= */
async function bouchonsState(){
  const res = await fetch(`${APPS_SCRIPT_URL}?action=bouchons_state&t=${Date.now()}`, { method:"GET", cache:"no-store" });
  return await res.json();
}
async function bouchonsGuess(guess){
  const res = await fetch(APPS_SCRIPT_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"bouchons_guess", guess })
  });
  return await res.json();
}
async function bouchonsReset(code){
  const url = `${APPS_SCRIPT_URL}?action=bouchons_reset&code=${encodeURIComponent(code)}&t=${Date.now()}`;
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  return await res.json();
}

const BOUCHONS_MAX_DIFF = 250;
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function updateBouchonsGauge(diff){
  const fill = $("bThermoFill");
  const txt  = $("bThermoText");
  if(!fill || !txt) return;

  const d = clamp(Number(diff), 0, BOUCHONS_MAX_DIFF);
  const pct = Math.round((1 - (d / BOUCHONS_MAX_DIFF)) * 100);

  const hue = Math.round(210 * (1 - pct/100));
  fill.style.width = pct + "%";
  fill.style.backgroundColor = `hsl(${hue} 85% 55%)`;

  let label = "ü•∂ Tr√®s loin";
  if(pct >= 20) label = "üßä Loin";
  if(pct >= 40) label = "üôÇ Ti√®de";
  if(pct >= 60) label = "üå°Ô∏è Chaud";
  if(pct >= 80) label = "üî• Tr√®s chaud";
  if(pct >= 95) label = "üö® Br√ªlant";

  txt.textContent = `${label} ‚Äî ${pct}%`;
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  for(const el of screenEls()) el.style.display = "none";

  renderTables();
  renderMenu();
  updateBadge();
  updateCountUI();
  setTypeUI(getPhotoType());
  updateSwitchCamUI();
  updateMissionPill();

  setScreen("screenHome");

  // Home nav
  $("homeTable").onclick = () => setScreen("screenTable");
  $("homeMenu").onclick = () => setScreen("screenMenu");
  $("homeAlbum").onclick = async () => { setScreen("screenAlbum"); await loadGallery(); };
  $("homeGames").onclick = () => setScreen("screenGames");

  // Back
  $("backFromTable").onclick = () => setScreen("screenHome");
  $("backFromMenu").onclick = () => setScreen("screenHome");
  $("backFromAlbum").onclick = () => setScreen("screenHome");
  $("backFromGames").onclick = () => setScreen("screenHome");

  // Album controls
  $("refreshGallery").onclick = loadGallery;
  $("openDriveAlbum").onclick = () => window.open(`https://drive.google.com/drive/folders/${encodeURIComponent(DRIVE_ALBUM_FOLDER_ID)}`, "_blank", "noopener");

  $("closeViewer").onclick = closeViewer;
  $("prevPhoto").onclick = prevViewer;
  $("nextPhoto").onclick = nextViewer;

  $("viewer").addEventListener("click", (e) => { if(e.target.id === "viewer") closeViewer(); });

  // Clavier (PC)
  document.addEventListener("keydown", (e) => {
    if($("viewer").style.display === "block"){
      if(e.key === "Escape") closeViewer();
      if(e.key === "ArrowLeft") prevViewer();
      if(e.key === "ArrowRight") nextViewer();
    }
  });

  // Swipe (mobile)
  let touchStartX = 0, touchStartY = 0;
  $("viewer").addEventListener("touchstart", (e) => {
    const t = e.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
  }, { passive:true });

  $("viewer").addEventListener("touchend", (e) => {
    const t = e.changedTouches[0];
    const dx = t.clientX - touchStartX;
    const dy = t.clientY - touchStartY;
    if(Math.abs(dy) > Math.abs(dx)) return;
    if(dx > 50) prevViewer();
    else if(dx < -50) nextViewer();
  }, { passive:true });

  // Reset table
  $("resetBtn").onclick = () => {
    setTableId(0);
    updateBadge();
    setScreen("screenTable");
  };

  // Games
  $("goPhoto").onclick = () => {
    clearMission();
    $("sendStatus").textContent = "";
    $("retakeBtn").style.display = "none";
    setTypeUI("libre");
    setScreen("screenPhoto");
  };
  $("goDefis").onclick = () => { renderDefis(); setScreen("screenDefis"); };

  $("goCodeGame").onclick = () => { renderCodeGame(); setScreen("screenCodeGame"); };

  $("goBouchons").onclick = async () => {
    setScreen("screenBouchons");
    $("bGuess").value = "";
    $("bHint").style.display = "none";
    $("bThermoFill").style.width = "0%";
    $("bThermoText").textContent = "";
    $("bStatus").textContent = "";

    const st = await bouchonsState();
    if(st.locked){
      $("bLockInfo").innerHTML = `<span class="ok">‚úÖ Jeu termin√© : un gagnant a trouv√© le bon nombre.</span>`;
      $("bSubmit").disabled = true;
      $("bGuess").disabled = true;
      updateBouchonsGauge(0);
      $("bHint").style.display = "block";
      $("bHint").textContent = "‚úÖ Trouv√© !";
    } else {
      $("bLockInfo").innerHTML = `<span class="muted">Jeu ouvert : √† vous de jouer !</span>`;
      $("bSubmit").disabled = false;
      $("bGuess").disabled = false;
    }
  };

  // Back modules
  $("backFromDefis").onclick = () => setScreen("screenGames");
  $("backFromCode").onclick = () => setScreen("screenGames");
  $("backFromBouchons").onclick = () => setScreen("screenGames");

  // Photo type buttons
  document.querySelectorAll(".typeBtn").forEach(btn => {
    btn.onclick = () => {
      clearMission();
      setTypeUI(btn.dataset.type);
      updateMissionPill();
    };
  });

  // Photo controls
  $("startCamBtn").onclick = startCamera;
  $("takePhotoBtn").onclick = takePhoto;
  $("switchCamBtn").onclick = () => {
    cameraMode = (cameraMode === "environment") ? "user" : "environment";
    localStorage.setItem(LS.camMode, cameraMode);
    spinFlipIcon();
    updateSwitchCamUI();
    if (camStream) startCamera();
  };
  $("retakeBtn").onclick = () => {
    capturedDataUrl = null;
    $("sendStatus").innerHTML = `<span class="muted">üì∏ Reprends la photo</span>`;
  };
  $("backFromPhoto").onclick = () => {
    stopCamera();
    setScreen("screenGames");
  };

  // Defis reset
  $("resetDefisBtn").onclick = () => { resetDefis(); renderDefis(); };

  // Code reset
  $("resetCodeBtn").onclick = () => { resetCodeGame(); renderCodeGame(); };

  // Bouchons submit
  $("bSubmit").onclick = async () => {
    const guess = Number($("bGuess").value);
    if(!Number.isFinite(guess) || guess < 0){
      $("bStatus").innerHTML = `<span class="err">Entre un nombre valide.</span>`;
      return;
    }

    $("bStatus").textContent = "Analyse‚Ä¶";
    const st = await bouchonsGuess(guess);

    $("bHint").style.display = "block";
    if(st.tooLow) $("bHint").textContent = "üìà Trop bas";
    else if(st.tooHigh) $("bHint").textContent = "üìâ Trop haut";

    if(typeof st.diff === "number") updateBouchonsGauge(st.diff);

    if(st.locked){
      $("bLockInfo").innerHTML = `<span class="ok">‚úÖ Jeu termin√© : un gagnant a trouv√© le bon nombre.</span>`;
      $("bSubmit").disabled = true;
      $("bGuess").disabled = true;
      $("bStatus").innerHTML = `<span class="ok">‚úÖ Trouv√© ! Jeu bloqu√©.</span>`;
      $("bHint").textContent = "‚úÖ Trouv√© !";
    } else {
      $("bLockInfo").innerHTML = `<span class="muted">Jeu ouvert : √† vous de jouer !</span>`;
      $("bStatus").textContent = st.message || "Enregistr√©.";
    }
  };

  // Admin reset (appui long sur header)
  let holdTimer = null;
  $("brandHold").addEventListener("pointerdown", () => {
    holdTimer = setTimeout(() => {
      $("bAdminReset").classList.toggle("show");
    }, 1200);
  });
  ["pointerup","pointercancel","pointerleave"].forEach(evt => {
    $("brandHold").addEventListener(evt, () => { if(holdTimer) clearTimeout(holdTimer); holdTimer = null; });
  });

  $("bAdminReset").onclick = async () => {
    const code = prompt("Code ADMIN pour r√©initialiser le jeu :");
    if(!code) return;

    $("bStatus").textContent = "‚è≥ R√©initialisation‚Ä¶";
    $("bAdminReset").disabled = true;

    try{
      const r = await bouchonsReset(code);
      if(!r.ok){
        $("bStatus").innerHTML = `<span class="err">${r.message || "Erreur reset"}</span>`;
        return;
      }

      const st = await bouchonsState();
      if(st.locked){
        $("bStatus").innerHTML = `<span class="err">Reset re√ßu mais le jeu est encore verrouill√© (d√©ploiement pas √† jour).</span>`;
      } else {
        $("bStatus").innerHTML = `<span class="ok">‚úÖ Jeu r√©initialis√©</span>`;
        $("bGuess").value = "";
        $("bHint").style.display = "none";
        $("bThermoText").textContent = "";
        $("bThermoFill").style.width = "0%";
        $("bSubmit").disabled = false;
        $("bGuess").disabled = false;
        $("bLockInfo").innerHTML = `<span class="muted">Jeu ouvert : √† vous de jouer !</span>`;
      }
    } catch(e){
      $("bStatus").innerHTML = `<span class="err">‚ùå Reset bloqu√© (r√©seau/autorisation).</span>`;
    } finally {
      $("bAdminReset").disabled = false;
    }
  };
});
</script>
</body>
</html>
